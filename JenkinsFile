pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))      // 30 days retention
    }

    triggers {
        cron('0 17 * * *')    // RUN EVERY DAY AT 5 PM
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com',
            description: 'Enter report email (leave blank to use default)')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Playwright tag (ex: @smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Spec file to run')
        string(name: 'GOTO_URL', defaultValue: 'https://testpages.herokuapp.com/styled/tag/table.html',
            description: 'URL used inside Playwright tests')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'],
            description: 'Select browser to run')
    }

    environment {
        PWDEBUG = "0"
        GOTO_URL = "${params.GOTO_URL}"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm ci'
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                bat 'npx playwright install'
            }
        }

        stage('Configure Playwright') {
            steps {
                script {
                    writeFile file: 'playwright.config.ts', text: """
                        import { defineConfig } from '@playwright/test';

                        export default defineConfig({
                            testDir: './tests',
                            retries: 1,

                            reporter: [
                                ['html', { outputFolder: 'reports/html-report', open: 'never' }],
                                ['json', { outputFile: 'reports/json-report/results.json' }],
                                ['allure-playwright']
                            ],

                            use: {
                                screenshot: 'only-on-failure',
                                video: 'retain-on-failure',
                                trace: 'retain-on-failure'
                            },

                            projects: [
                                { name: 'chromium', use: { browserName: 'chromium' }},
                                { name: 'firefox', use: { browserName: 'firefox' }},
                                { name: 'webkit', use: { browserName: 'webkit' }}
                            ]
                        });
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "npx playwright test"

                    if (params.SPEC_FILE?.trim()) {
                        cmd += " ${params.SPEC_FILE}"
                    }
                    if (params.TEST_TAG?.trim()) {
                        cmd += " --grep=\"${params.TEST_TAG}\""
                    }
                    if (params.BROWSER != 'all') {
                        cmd += " --project=${params.BROWSER}"
                    }

                    echo "‚ñ∂ Running: ${cmd}"

                    bat """
                    set GOTO_URL=${GOTO_URL}
                    ${cmd}
                    """
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "npx allure generate allure-results --clean -o reports/allure-report"
            }
        }

        stage('Archive & Publish Reports') {
            steps {

                archiveArtifacts artifacts: """
                    reports/**,
                    allure-results/**,
                    **/screenshots/**,
                    **/videos/**,
                    **/trace/**,
                """, followSymlinks: false

                publishHTML(target: [
                    reportName: "Playwright HTML Report",
                    reportDir: "reports/html-report",
                    reportFiles: "index.html",
                    keepAll: true
                ])

                allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            }
        }
    }

    post {
        always {
            script {
                def recipient = params.EMAIL?.trim() ?
                                params.EMAIL :
                                "leelasonu12@gmail.com"

                echo "üìß Sending report to: ${recipient}"

                emailext(
                    to: recipient,
                    subject: "Playwright Test Report - Build #${env.BUILD_NUMBER}",
                    mimeType: 'text/html',
                    body: """
                        <h2>Playwright Execution Completed</h2>
                        <p><b>Status:</b> ${currentBuild.currentResult}</p>
                        <p><a href="${env.BUILD_URL}Playwright_HTML_Report">HTML Report</a></p>
                        <p><a href="${env.BUILD_URL}allure">Allure Report</a></p>
                    """
                )
            }
        }

        success {
            echo "üéâ Build Successful ‚Äî Reports generated!"
        }

        failure {
            echo "‚ùå Build Failed ‚Äî Check reports, screenshots, videos, traces."
        }
    }
}
