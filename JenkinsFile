pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    triggers {
        cron('0 17 * * *')   // run everyday 5 PM
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email to receive reports')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Run by tag (@smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Run specific spec file')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to run')
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm ci'
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                bat 'npx playwright install'
            }
        }

        stage('Load ENV File') {
            steps {
                script {
                    def props = readProperties file: '.env'
                    props.each { key, value -> env[key] = value }
                    echo "Loaded ENV variables: ${props.keySet()}"
                }
            }
        }

        stage('Configure Playwright') {
            steps {
                script {
                    writeFile file: 'playwright.config.ts', text: """
                        import { defineConfig } from '@playwright/test';

                        export default defineConfig({
                            testDir: './tests',
                            retries: 1,

                            reporter: [
                                ['html', { outputFolder: 'reports/html-report', open: 'never' }],
                                ['json', { outputFile: 'reports/json-report/results.json' }],
                                ['allure-playwright']
                            ],

                            use: {
                                screenshot: 'only-on-failure',
                                video: 'retain-on-failure',
                                trace: 'retain-on-failure'
                            },

                            projects: [
                                { name: 'chromium', use: { browserName: 'chromium' }},
                                { name: 'firefox', use: { browserName: 'firefox' }},
                                { name: 'webkit', use: { browserName: 'webkit' }}
                            ]
                        });
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "npx playwright test"

                    if (params.SPEC_FILE?.trim()) {
                        cmd += " ${params.SPEC_FILE}"
                    }
                    if (params.TEST_TAG?.trim()) {
                        cmd += " --grep=\"${params.TEST_TAG}\""
                    }
                    if (params.BROWSER != 'all') {
                        cmd += " --project=${params.BROWSER}"
                    }

                    echo "‚ñ∂ Running: ${cmd}"
                    bat cmd
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "npx allure generate allure-results --clean -o reports/allure-report"
            }
        }

        stage('Archive Reports & Artifacts') {
            steps {
                archiveArtifacts artifacts: """
                    reports/**,
                    allure-results/**,
                    test-results/**,
                    **/video.webm,
                    **/screenshot.png,
                    **/trace.zip
                """, followSymlinks: false

                publishHTML(target: [
                    reportName: "Playwright HTML Report",
                    reportDir: "reports/html-report",
                    reportFiles: "index.html",
                    keepAll: true
                ])

                allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            }
        }
    }

    post {
        always {
            script {

                // Read failed tests from JSON
                def jsonReport = readJSON file: 'reports/json-report/results.json'
                def failedTests = jsonReport.suites.collectMany { it.specs }
                    .findAll { it.status == 'failed' }
                    .collect { it.title }

                def failedList = failedTests ? failedTests.join("<br>") : "All Tests Passed üéâ"

                def recipient = params.EMAIL?.trim() ? params.EMAIL : "leelasonu12@gmail.com"

                emailext(
                    to: recipient,
                    subject: "Playwright Test Report - Build #${env.BUILD_NUMBER}",

                    body: """
                        <h2>Playwright Test Execution Completed</h2>
                        <p><b>Status:</b> ${currentBuild.currentResult}</p>

                        <h3>üõë Failed Testcases:</h3>
                        <p>${failedList}</p>

                        <h3>üìÑ Reports</h3>
                        <p><b>HTML Report:</b> <a href="${env.BUILD_URL}Playwright_HTML_Report">View HTML Report</a></p>
                        <p><b>Allure Report:</b> <a href="${env.BUILD_URL}allure">View Allure Report</a></p>
                        <p><b>JSON Report:</b> <a href="${env.BUILD_URL}artifact/reports/json-report/results.json">Download JSON</a></p>

                        <h3>üé• Videos, üì∏ Screenshots, üß≠ Trace Viewer</h3>
                        <p><a href="${env.BUILD_URL}artifact/">Browse Artifacts (videos/screenshots/traces)</a></p>

                        <hr>
                        <p>Triggered from Jenkins Pipeline</p>
                    """,
                    mimeType: 'text/html'
                )
            }
        }

        success {
            echo "üéâ Build Successful ‚Äî Reports Generated"
        }

        failure {
            echo "‚ùå Build Failed ‚Äî Check Reports and Artifacts"
        }
    }
}
