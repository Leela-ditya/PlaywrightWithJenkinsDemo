pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', defaultValue: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git', description: 'GitHub Repo URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch name')

        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Choose Browser')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Enter Tag (ex: @smoke). Leave empty if selecting SPEC.')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Enter Spec File (ex: tests/login.spec.ts). Leave empty if using TAG.')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.BRANCH}"]],
                    userRemoteConfigs: [[url: params.GITHUB_REPO_URL]]
                ])
            }
        }

        stage('Validate Input') {
            steps {
                script {
                    def hasTag = params.TEST_TAG?.trim()
                    def hasSpec = params.SPEC_FILE?.trim()

                    if (hasTag && hasSpec) {
                        error "‚ùå ERROR: You must provide ONLY one ‚Äî TAG or SPEC, not both."
                    }

                    if (!hasTag && !hasSpec) {
                        echo "‚ö† No TAG or SPEC provided ‚Äî Running full test suite."
                    }
                }
            }
        }

        stage('Setup Environment') {
            steps {
                bat '''
                    npm install
                    npx playwright install
                '''
            }
        }

        stage('Run Playwright Tests') {
    steps {
        script {
            def browserOption = "--project=${params.BROWSER}"

            def runCommand = ""

            if (params.TEST_TAG?.trim()) {
                runCommand = "npx playwright test --grep ${params.TEST_TAG} ${browserOption} --reporter=html,json,junit,allure-playwright"
            } 
            else if (params.SPEC_FILE?.trim()) {
                runCommand = "npx playwright test ${params.SPEC_FILE} ${browserOption} --reporter=html,json,junit,allure-playwright"
            } 
            else {
                runCommand = "npx playwright test ${browserOption} --reporter=html,json,junit,allure-playwright"
            }

            bat """
                echo Running: ${runCommand}
                ${runCommand} || exit /b 0
            """
        }
    }
}


        stage('Generate Allure Report') {
            steps {
                bat '''
                    if exist allure-results (
                        npx allure generate allure-results --clean -o allure-report
                    )
                '''
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    publishHTML([
                        reportDir: 'playwright-report',
                        reportFiles: 'index.html',
                        reportName: 'Playwright HTML Report',
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])

                    allure([
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'allure-results']]
                    ])

                    junit allowEmptyResults: true, testResults: 'test-results/**/*.xml'

                    archiveArtifacts artifacts: 'playwright-report/**, allure-report/**, test-results/**, screenshots/**, videos/**, traces/**',
                                     allowEmptyArchive: true
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Tests Passed Successfully!"
        }
        failure {
            echo "‚ùå Tests Failed ‚Äî Check the Reports."
        }
    }
}
