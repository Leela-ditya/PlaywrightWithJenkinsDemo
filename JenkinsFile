pipeline {
    agent any

    parameters {
        string(name: 'GITHUB_URL', defaultValue: '', description: 'GitHub Repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch Name')
        string(name: 'TAG', defaultValue: '', description: 'Test Tag (optional)')
        string(name: 'SPEC', defaultValue: '', description: 'Test Spec Pattern (optional)')
        string(name: 'EMAIL_RECIPIENTS', defaultValue: '', description: 'Email Recipients (comma separated)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to Run Tests')
    }

    environment {
        REPO_DIR = "${WORKSPACE}\\playwright-repo"
        REPORTS_DIR = "${REPO_DIR}\\reports"
        ALLURE_RESULTS_DIR = "${REPO_DIR}\\allure-results"
        FINAL_REPORTS_DIR = "${WORKSPACE}\\reports"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'Minutes')
    }

    stages {
        stage('Git Change Detection & Checkout') {
            steps {
                script {
                    if (!fileExists("${REPO_DIR}\\.git")) {
                        echo "Cloning repository for the first time..."
                        bat '''
                            rmdir /s /q "${REPO_DIR}" 2>nul || true
                            git clone -b ${BRANCH} ${GITHUB_URL} "${REPO_DIR}"
                        '''
                    } else {
                        echo "Repository exists. Checking for changes..."
                        dir("${REPO_DIR}") {
                            bat '''
                                git fetch origin %BRANCH%
                                for /f %%i in ('git rev-parse HEAD') do set CURRENT_COMMIT=%%i
                                for /f %%i in ('git rev-parse origin/%BRANCH%') do set REMOTE_COMMIT=%%i
                                
                                if "%CURRENT_COMMIT%"=="%REMOTE_COMMIT%" (
                                    echo No changes detected. Using existing repository.
                                ) else (
                                    echo Changes detected. Pulling updates...
                                    git pull origin %BRANCH%
                                )
                            '''
                        }
                    }
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        bat '''
                            if not exist "node_modules" (
                                echo Installing dependencies...
                                npm install
                            ) else (
                                echo Dependencies already installed.
                            )
                        '''
                    }
                }
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        bat 'npx playwright install'
                    }
                }
            }
        }

        stage('Clean Previous Reports') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        bat '''
                            rmdir /s /q "reports" 2>nul || true
                            rmdir /s /q "allure-results" 2>nul || true
                            rmdir /s /q "test-results" 2>nul || true
                        '''
                    }
                }
            }
        }

        stage('Check & Install Allure') {
            steps {
                script {
                    bat '''
                        where allure >nul 2>nul
                        if errorlevel 1 (
                            echo Allure not found. Installing...
                            npm install -g allure-commandline
                        ) else (
                            echo Allure is already installed.
                        )
                    '''
                }
            }
        }

        stage('Run Playwright Tests') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        try {
                            bat '''
                                set SPEC_PATTERN=${SPEC}
                                if "%SPEC_PATTERN%"=="" set SPEC_PATTERN=.
                                
                                if "${BROWSER}"=="all" (
                                    npx playwright test "%SPEC_PATTERN%" --reporter=html,json,junit,allure > test-output.log 2>&1
                                ) else (
                                    npx playwright test "%SPEC_PATTERN%" --project="${BROWSER}" --reporter=html,json,junit,allure > test-output.log 2>&1
                                )
                            '''
                        } catch (Exception e) {
                            echo "Tests failed or encountered an error: ${e.message}"
                        }
                    }
                }
            }
        }

        stage('Extract Test Counts') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        bat '''
                            if exist "reports\\index.html" (
                                for /f "tokens=*" %%i in ('findstr /c:"passed" reports\\index.html ^| find /c /v ""') do set TOTAL_TESTS=%%i
                                for /f "tokens=*" %%i in ('findstr /c:"failed" reports\\index.html ^| find /c /v ""') do set FAILED_TESTS=%%i
                            ) else (
                                set TOTAL_TESTS=0
                                set FAILED_TESTS=0
                            )
                            set /a PASSED_TESTS=%TOTAL_TESTS%-%FAILED_TESTS%
                            
                            (
                                echo TOTAL_TESTS=%TOTAL_TESTS%
                                echo PASSED_TESTS=%PASSED_TESTS%
                                echo FAILED_TESTS=%FAILED_TESTS%
                            ) > test-counts.properties
                        '''
                        
                        def props = readProperties(file: "${REPO_DIR}\\test-counts.properties")
                        env.TOTAL_TESTS = props['TOTAL_TESTS'] ?: '0'
                        env.PASSED_TESTS = props['PASSED_TESTS'] ?: '0'
                        env.FAILED_TESTS = props['FAILED_TESTS'] ?: '0'
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    dir("${REPO_DIR}") {
                        bat '''
                            if exist "allure-results" (
                                dir allure-results | find /c /v "" >nul
                                if not errorlevel 1 (
                                    allure generate allure-results -o allure-report --clean
                                ) else (
                                    echo No allure results found.
                                )
                            ) else (
                                echo No allure results found.
                            )
                        '''
                    }
                }
            }
        }

        stage('Organize & Copy Reports') {
            steps {
                script {
                    bat '''
                        rmdir /s /q "%FINAL_REPORTS_DIR%" 2>nul || true
                        mkdir "%FINAL_REPORTS_DIR%"
                        
                        if exist "%REPO_DIR%\\reports\\index.html" (
                            copy "%REPO_DIR%\\reports\\index.html" "%FINAL_REPORTS_DIR%\\"
                            echo HTML report copied
                        )
                        
                        if exist "%REPO_DIR%\\allure-report" (
                            xcopy "%REPO_DIR%\\allure-report" "%FINAL_REPORTS_DIR%\\allure-report" /E /I /Y >nul
                            
                            cd "%FINAL_REPORTS_DIR%\\allure-report"
                            for /f "delims=" %%A in ('cd') do set CURRENT_DIR=%%A
                            powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem; [System.IO.Compression.ZipFile]::CreateFromDirectory('%%CURRENT_DIR%%', '%%CURRENT_DIR%%\\..\\allure-results.zip')"
                            cd "%FINAL_REPORTS_DIR%"
                            echo Allure report zipped
                        )
                        
                        if exist "%REPO_DIR%\\test-results" (
                            mkdir "%FINAL_REPORTS_DIR%\\artifacts"
                            
                            for /d %%d in ("%REPO_DIR%\\test-results\\*") do (
                                if exist "%%d\\screenshots" xcopy "%%d\\screenshots" "%FINAL_REPORTS_DIR%\\artifacts\\screenshots" /E /I /Y >nul 2>&1
                                if exist "%%d\\video" xcopy "%%d\\video" "%FINAL_REPORTS_DIR%\\artifacts\\video" /E /I /Y >nul 2>&1
                                if exist "%%d\\trace" xcopy "%%d\\trace" "%FINAL_REPORTS_DIR%\\artifacts\\trace" /E /I /Y >nul 2>&1
                            )
                        )
                        
                        echo Reports organized successfully
                    '''
                }
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    publishHTML([
                        reportDir: "${FINAL_REPORTS_DIR}",
                        reportFiles: 'index.html',
                        reportName: 'Playwright HTML Report'
                    ])
                    
                    if (fileExists("${FINAL_REPORTS_DIR}/allure-report/index.html")) {
                        publishHTML([
                            reportDir: "${FINAL_REPORTS_DIR}/allure-report",
                            reportFiles: 'index.html',
                            reportName: 'Allure Report'
                        ])
                    }
                }
            }
        }

        stage('Send Email') {
            steps {
                script {
                    if (params.EMAIL_RECIPIENTS?.trim()) {
                        def buildStatus = currentBuild.result == 'FAILURE' ? 'FAILED' : 'PASSED'
                        def htmlReportLink = "${BUILD_URL}Playwright_HTML_Report"
                        def allureReportLink = fileExists("${FINAL_REPORTS_DIR}/allure-report/index.html") ? "${BUILD_URL}Allure_Report" : "Not Generated"
                        def consoleLink = "${BUILD_URL}console"
                        def artifactsLink = "${BUILD_URL}artifact/reports/artifacts/"
                        
                        def emailBody = """
                        <html>
                            <body style="font-family: Arial, sans-serif;">
                                <h2>Playwright Test Execution Report</h2>
                                <hr>
                                <table style="border-collapse: collapse; width: 100%;">
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Build Status:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd; color: ${buildStatus == 'PASSED' ? 'green' : 'red'};"><b>${buildStatus}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Build Number:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">#${BUILD_NUMBER}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Branch:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${BRANCH}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Tag:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${TAG ?: 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Spec:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${SPEC ?: 'All'}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Browser:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${BROWSER}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Total Tests:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${TOTAL_TESTS}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Passed:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd; color: green;"><b>${PASSED_TESTS}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;"><b>Failed:</b></td>
                                        <td style="padding: 8px; border: 1px solid #ddd; color: red;"><b>${FAILED_TESTS}</b></td>
                                    </tr>
                                </table>
                                <hr>
                                <h3>Report Links:</h3>
                                <ul>
                                    <li><a href="${htmlReportLink}">HTML Report</a></li>
                                    <li><a href="${allureReportLink}">Allure Report</a></li>
                                    <li><a href="${artifactsLink}">Screenshots & Videos</a></li>
                                    <li><a href="${consoleLink}">Console Output</a></li>
                                </ul>
                                <hr>
                                <footer style="font-size: 12px; color: #666;">
                                    This is an automated email from Jenkins Pipeline. Please do not reply to this email.
                                </footer>
                            </body>
                        </html>
                        """
                        
                        emailext(
                            subject: "Playwright Tests - Build #${BUILD_NUMBER} - ${buildStatus}",
                            body: emailBody,
                            mimeType: 'text/html',
                            to: params.EMAIL_RECIPIENTS,
                            recipientProviders: [developers(), requestor()]
                        )
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "Pipeline execution completed"
            }
        }
        failure {
            script {
                currentBuild.result = 'FAILURE'
            }
        }
        success {
            script {
                currentBuild.result = 'SUCCESS'
            }
        }
    }
}
