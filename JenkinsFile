pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', 
               defaultValue: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git', 
               description: 'GitHub Repository URL')

        string(name: 'BRANCH', defaultValue: 'main', description: 'Git Branch')

        choice(name: 'BROWSER', 
               choices: ['chromium', 'firefox', 'webkit'], 
               description: 'Choose Browser')

        string(name: 'TEST_TAG', 
               defaultValue: '', 
               description: 'Enter Tag (ex: @smoke). Leave empty if using SPEC.')

        string(name: 'SPEC_FILE', 
               defaultValue: '', 
               description: 'Enter Spec File (ex: tests/login.spec.ts). Leave empty if using TAG.')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.BRANCH}"]],
                    userRemoteConfigs: [[url: params.GITHUB_REPO_URL]]
                ])
            }
        }

        stage('Validate Input') {
            steps {
                script {
                    def hasTag = params.TEST_TAG?.trim()
                    def hasSpec = params.SPEC_FILE?.trim()

                    if (hasTag && hasSpec) {
                        error "‚ùå ERROR: Provide ONLY one ‚Äî TAG or SPEC, not both."
                    }

                    if (!hasTag && !hasSpec) {
                        echo "‚ö† No TAG or SPEC provided ‚Äî running entire test suite."
                    }
                }
            }
        }

        stage('Setup Environment') {
            steps {
                bat '''
                    npm install
                    npx playwright install
                '''
            }
        }

        stage('Run Playwright Tests') {
            steps {
                script {
                    def tag = params.TEST_TAG?.trim()
                    def spec = params.SPEC_FILE?.trim()

                    def command = "npx playwright test"

                    if (spec) {
                        command += " ${spec}"
                        echo "‚úî Running SPEC: ${spec}"
                    }

                    if (tag) {
                        command += " --grep ${tag}"
                        echo "‚úî Running TAG: ${tag}"
                    }

                    command += " --project=${params.BROWSER}"
                    command += " --reporter=html,json,junit,allure-playwright"

                    echo "Executing: ${command}"

                    bat """
                        ${command} --output=test-results --video=on --trace=on
                    """
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat '''
                    if exist allure-results (
                        npx allure generate allure-results --clean -o allure-report
                    )
                '''
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    publishHTML([
                        reportDir: 'playwright-report',
                        reportFiles: 'index.html',
                        reportName: 'Playwright HTML Report',
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])

                    allure([
                        results: [[path: 'allure-results']],
                        reportBuildPolicy: 'ALWAYS'
                    ])

                    junit allowEmptyResults: true, testResults: 'test-results/**/*.xml'

                    archiveArtifacts(
                        artifacts: 'playwright-report/**, allure-report/**, test-results/**, videos/**, traces/**',
                        allowEmptyArchive: true
                    )
                }
            }
        }
    }

    post {
        success {
            echo "üéâ Tests Passed Successfully!"
        }
        failure {
            echo "‚ùå Tests Failed ‚Äî Check Reports."
        }
    }
}