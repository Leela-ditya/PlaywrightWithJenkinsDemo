pipeline {
    agent any

    tools {
        nodejs "NodeJS_18"
    }

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    parameters {
        string(name: 'TAG', defaultValue: '', description: 'Enter Playwright tag (example: @smoke)')
        string(name: 'SPEC', defaultValue: '', description: 'Enter spec file to run (example: tests/login.spec.ts)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Choose Browser')
        string(name: 'EMAIL', defaultValue: 'yourgmail@gmail.com', description: 'Email to receive test status')
    }

    environment {
        ALLURE_HOME = "C:\\Users\\${env.USERNAME}\\scoop\\apps\\allure\\current"
        PATH = "${ALLURE_HOME}\\bin;${PATH}"
        REPORTS_DIR = "test-reports"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm install'
                bat 'npx playwright install'
            }
        }

        stage('Prepare Report Folders') {
            steps {
                bat """
                    if exist %REPORTS_DIR% rmdir /s /q %REPORTS_DIR%
                    mkdir %REPORTS_DIR%\\html
                    mkdir %REPORTS_DIR%\\json
                    mkdir %REPORTS_DIR%\\junit
                    mkdir %REPORTS_DIR%\\allure-results
                """
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    // ❌ Prevent user from selecting both TAG & SPEC
                    if (params.TAG && params.SPEC) {
                        error("❌ You cannot enter both TAG and SPEC. Choose only one.")
                    }

                    def testCmd = "npx playwright test"
                    
                    if (params.TAG) {
                        testCmd += " --grep ${params.TAG}"
                    }

                    if (params.SPEC) {
                        testCmd += " ${params.SPEC}"
                    }

                    if (params.BROWSER) {
                        testCmd += " --project=${params.BROWSER}"
                    }

                    // Enable all artifacts
                    testCmd += " --reporter=line,html,json,junit"

                    // Run Playwright
                    bat testCmd

                    // Copy reports to a single directory
                    bat """
                        xcopy /E /I /Y playwright-report %REPORTS_DIR%\\html
                        xcopy /E /I /Y test-results %REPORTS_DIR%\\json
                        xcopy /E /I /Y test-results %REPORTS_DIR%\\junit
                        xcopy /E /I /Y allure-results %REPORTS_DIR%\\allure-results
                    """
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "allure generate %REPORTS_DIR%\\allure-results --clean -o %REPORTS_DIR%\\allure-report"
            }
        }

        stage('Publish Reports') {
            steps {

                // HTML report (Playwright)
                publishHTML(target: [
                    reportDir: "${REPORTS_DIR}\\html",
                    reportFiles: 'index.html',
                    reportName: 'Playwright HTML Report'
                ])

                // JUnit XML
                junit "${REPORTS_DIR}/junit/*.xml"

                // Allure Plugin
                allure([
                    includeProperties: false,
                    jdk: '',
                    results: [[path: "${REPORTS_DIR}/allure-results"]]
                ])
            }
        }

        stage('Archive All Files') {
            steps {
                archiveArtifacts artifacts: "${REPORTS_DIR}/**", fingerprint: true
            }
        }
    }

    post {
        always {
            script {
                def status = currentBuild.currentResult

                emailext(
                    subject: "Playwright Test Status: ${status}",
                    body: """
                    <h2>Playwright Test Execution Completed</h2>
                    Status: <b>${status}</b><br><br>

                    Reports Generated:<br>
                    - HTML Report<br>
                    - JSON Report<br>
                    - JUnit XML Report<br>
                    - Allure Report<br>
                    - Video, Screenshots & Trace in test-results folder<br><br>

                    <b>Check Jenkins Artifacts for full results.</b>
                    """,
                    attachLog: true,
                    attachmentsPattern: "${REPORTS_DIR}/junit/*.xml",
                    to: "${params.EMAIL}"
                )
            }
        }
    }
}
