pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    triggers {
        cron('0 17 * * *')   // Daily @ 5 PM
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email to receive reports')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Playwright tag to run (@smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Spec file path')
        string(name: 'GOTO_URL', defaultValue: 'https://testautomationpractice.blogspot.com/p/playwrightpractice.html', description: 'Base URL for tests')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Select browser')
    }

    environment {
        PWDEBUG = "0"
        GOTO_URL = "${params.GOTO_URL}"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat "npm ci"
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                bat "npx playwright install"
            }
        }

        stage('Configure Playwright') {
            steps {
                script {
                    writeFile file: 'playwright.config.ts', text: """
                        import { defineConfig } from '@playwright/test';

                        export default defineConfig({
                            testDir: './tests',
                            retries: 1,

                            reporter: [
                                ['html', { outputFolder: 'reports/html-report', open: 'never' }],
                                ['json', { outputFile: 'reports/json-report/results.json' }],
                                ['allure-playwright']
                            ],

                            use: {
                                screenshot: 'only-on-failure',
                                video: 'retain-on-failure',
                                trace: 'retain-on-failure',
                                baseURL: '${params.GOTO_URL}'
                            },

                            projects: [
                                { name: 'chromium', use: { browserName: 'chromium' }},
                                { name: 'firefox', use: { browserName: 'firefox' }},
                                { name: 'webkit', use: { browserName: 'webkit' }}
                            ]
                        });
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def testCommand = "npx playwright test"

                    if (params.SPEC_FILE?.trim()) {
                        testCommand += " ${params.SPEC_FILE}"
                    }

                    if (params.TEST_TAG?.trim()) {
                        testCommand += " --grep=\"${params.TEST_TAG}\""
                    }

                    if (params.BROWSER != 'all') {
                        testCommand += " --project=${params.BROWSER}"
                    }

                    echo "‚ñ∂ Running Command: ${testCommand}"

                    bat """
                    set GOTO_URL=${GOTO_URL}
                    ${testCommand}
                    """
                }
            }
        }

    }

    post {

        /* ALWAYS GENERATE REPORTS (even if test failed) */
        always {

            echo "üìä Generating Allure Report"
            bat "npx allure generate allure-results --clean -o reports/allure-report || true"

            echo "üì¶ Archiving All Reports & Artifacts"
            archiveArtifacts artifacts: """
                reports/**,
                reports/html-report/**,
                reports/json-report/**,
                reports/allure-report/**,
                allure-results/**,
                **/screenshots/**,
                **/videos/**,
                **/trace/**
            """, allowEmptyArchive: true

            publishHTML(target: [
                reportName: "Playwright HTML Report",
                reportDir: "reports/html-report",
                reportFiles: "index.html",
                keepAll: true
            ])

            publishHTML(target: [
                reportName: "Allure Report",
                reportDir: "reports/allure-report",
                reportFiles: "index.html",
                keepAll: true
            ])
        }

        /* ALWAYS SEND EMAIL */
        always {
            script {
                def recipient = params.EMAIL?.trim() ? params.EMAIL : "leelasonu12@gmail.com"
                echo "üìß Sending report to: ${recipient}"

                emailext(
                    to: recipient,
                    subject: "Playwright Report - Build #${env.BUILD_NUMBER} (${currentBuild.currentResult})",
                    body: """
                        <h2>Playwright Execution Completed</h2>
                        <p>Status: <b>${currentBuild.currentResult}</b></p>

                        <h3>Report Links</h3>
                        <ul>
                            <li><a href="${env.BUILD_URL}Playwright_20HTML_20Report/">HTML Report</a></li>
                            <li><a href="${env.BUILD_URL}Allure_20Report/">Allure Report</a></li>
                            <li><a href="${env.BUILD_URL}artifact/">Artifacts (Screenshots, Videos, Trace)</a></li>
                        </ul>

                        <p>Triggered by Jenkins Pipeline.</p>
                    """,
                    mimeType: 'text/html'
                )
            }
        }

        success {
            echo "üéâ SUCCESS ‚Äî All reports generated!"
        }

        failure {
            echo "‚ùå FAILURE ‚Äî Reports generated. Check HTML, JSON, Allure, Screenshots, Video, Trace."
        }
    }
}
