pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(daysToKeepStr: '30')) // Keep builds for 30 days
    }

    parameters {
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Choose browser')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Enter tag (e.g., @smoke). Leave empty if using SPEC.')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Enter spec file (e.g., tests/login.spec.ts). Leave empty if using TAG.')
    }

    stages {
        stage('Install Dependencies') {
            steps {
                bat '''
                    npm ci
                    npx playwright install
                '''
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def tag = params.TEST_TAG?.trim()
                    def spec = params.SPEC_FILE?.trim()
                    def command = "npx playwright test"

                    if (spec) {
                        command += " ${spec}"
                    } else if (tag) {
                        command += " --grep ${tag}"
                    }

                    command += " --project=${params.BROWSER}"
                    command += " --reporter=html,json,junit,allure-playwright"

                    bat "${command} --output=test-results --video=on --trace=on"
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat 'npx allure generate allure-results --clean -o allure-report'
            }
        }

        stage('Publish Reports') {
            steps {
                publishHTML([
                    reportDir: 'playwright-report',
                    reportFiles: 'index.html',
                    reportName: 'Playwright HTML Report',
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])

                allure([
                    results: [[path: 'allure-results']],
                    reportBuildPolicy: 'ALWAYS'
                ])

                junit allowEmptyResults: true, testResults: 'test-results/**/*.xml'

                archiveArtifacts artifacts: 'playwright-report/**, allure-report/**, test-results/**', allowEmptyArchive: true
            }
        }
    }

    post {
        success {
            echo "✅ Tests passed successfully!"
        }
        failure {
            echo "❌ Tests failed. Check reports for details."
        }
    }
}