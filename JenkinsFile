pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))  // keep reports for 1 month (set '' for forever)
    }

    triggers {
        cron('0 17 * * *')   // AUTO RUN EVERYDAY AT 5 PM
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Enter email to receive reports (leave empty to use default)')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Enter tag to run (example: @smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Enter spec file (example: tests/example.spec.ts)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Select browser to run')
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm ci'
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                bat 'npx playwright install'
            }
        }

        stage('Configure Playwright') {
            steps {
                script {
                    writeFile file: 'playwright.config.ts', text: """
                        import { defineConfig } from '@playwright/test';

                        export default defineConfig({
                            testDir: './tests',
                            retries: 1,  

                            reporter: [
                                ['html', { outputFolder: 'reports/html-report', open: 'never' }],
                                ['json', { outputFile: 'reports/json-report/results.json' }],
                                ['allure-playwright']
                            ],

                            use: {
                                screenshot: 'only-on-failure',
                                video: 'retain-on-failure',
                                trace: 'retain-on-failure'
                            },

                            projects: [
                                { name: 'chromium', use: { browserName: 'chromium' }},
                                { name: 'firefox', use: { browserName: 'firefox' }},
                                { name: 'webkit', use: { browserName: 'webkit' }}
                            ]
                        });
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {

                    def testCommand = "npx playwright test"

                    // SPEC FILE
                    if (params.SPEC_FILE?.trim()) {
                        testCommand += " ${params.SPEC_FILE}"
                    }

                    // TAG
                    if (params.TEST_TAG?.trim()) {
                        testCommand += " --grep=\"${params.TEST_TAG}\""
                    }

                    // BROWSER
                    if (params.BROWSER != 'all') {
                        testCommand += " --project=${params.BROWSER}"
                    }

                    echo "‚ñ∂ Running: ${testCommand}"
                    bat testCommand
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "npx allure generate allure-results --clean -o reports/allure-report"
            }
        }

        stage('Archive & Publish Reports') {
            steps {

                archiveArtifacts artifacts: """
                    reports/**,
                    reports/html-report/**,
                    reports/json-report/**,
                    reports/allure-report/**,
                    allure-results/**,
                    **/screenshots/**,
                    **/videos/**,
                    **/trace/**,
                """, followSymlinks: false

                publishHTML(target: [
                    reportName: "Playwright HTML Report",
                    reportDir: "reports/html-report",
                    reportFiles: "index.html",
                    keepAll: true
                ])

                allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            }
        }
    }

    post {

        always {
            script {
                // Determine final email ‚Üí parameter or default
                def recipient = params.EMAIL?.trim() ? params.EMAIL : "leelasonu12@gmail.com"

                echo "üìß Sending report to: ${recipient}"

                emailext(
                    to: recipient,
                    subject: "Playwright Test Report - Build #${env.BUILD_NUMBER}",
                    body: """
                        <h2>Playwright Automation Execution Completed</h2>
                        <p><b>Status:</b> ${currentBuild.currentResult}</p>
                        <p><b>HTML Report:</b> <a href="${env.BUILD_URL}Playwright_HTML_Report">Click to view</a></p>
                        <p><b>Allure Report:</b> <a href="${env.BUILD_URL}allure">Click to view</a></p>

                        <p>Triggered By Jenkins Pipeline.</p>
                    """,
                    mimeType: 'text/html'
                )
            }
        }

        success {
            echo "üéâ Build Successful ‚Äî All reports generated!"
        }

        failure {
            echo "‚ùå Build Failed ‚Äî Check HTML, JSON, Allure, Screenshots, Videos, Trace."
        }
    }
}
