pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(daysToKeepStr: '30'))  // keep reports for 1 month
    }

    parameters {
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Choose Playwright Browser')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Enter Playwright tag (example: @smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Enter spec file to run (example: tests/example.spec.ts)')
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "Cloning GitHub repo..."
                git branch: 'main',
                    url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "Installing Playwright dependencies..."
                bat """
                    npm install
                    npx playwright install %BROWSER% --with-deps
                """
            }
        }

        stage('Install Allure CLI (Windows)') {
            steps {
                echo "Installing Allure command-line..."
                bat 'npm install -g allure-commandline --force'
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "npx playwright test --browser=${params.BROWSER} --reporter=line,html,json,allure-playwright"

                    if (params.TEST_TAG?.trim()) {
                        cmd = "npx playwright test --grep @${params.TEST_TAG} --browser=${params.BROWSER} --reporter=line,html,json,allure-playwright"
                    }

                    if (params.SPEC_FILE?.trim()) {
                        cmd = "npx playwright test ${params.SPEC_FILE} --browser=${params.BROWSER} --reporter=line,html,json,allure-playwright"
                    }

                    echo "Running: ${cmd}"

                    bat """
                        ${cmd}
                    """
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                echo "Generating Allure report..."
                bat """
                    allure generate allure-results --clean -o allure-report
                """
            }
        }

        stage('Archive Reports') {
            steps {
                echo "Archiving HTML, JSON, and Allure reports..."
                archiveArtifacts artifacts: 'playwright-report/**', allowEmptyArchive: true
                archiveArtifacts artifacts: 'test-results/**/*.json', allowEmptyArchive: true
                archiveArtifacts artifacts: 'allure-report/**', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo "Build completed. Reports generated."
        }
        failure {
            echo "Test FAILED — Reports are available."
        }
        success {
            echo "Test PASSED — Reports available."
        }
    }
}
