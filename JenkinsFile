pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    triggers {
        cron('0 17 * * *')   // Run everyday 5 PM
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email to receive reports')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Run by tag (@smoke)')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Run specific spec file')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to run')
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'npm ci'
            }
        }

        stage('Install Playwright Browsers') {
            steps {
                bat 'npx playwright install'
            }
        }

        stage('Write Playwright Config') {
            steps {
                script {
                    writeFile file: 'playwright.config.ts', text: """
                        import { defineConfig } from '@playwright/test';

                        export default defineConfig({
                            testDir: './tests',
                            retries: 1,

                            reporter: [
                                ['html', { outputFolder: 'reports/html-report', open: 'never' }],
                                ['json', { outputFile: 'reports/json-report/results.json' }],
                                ['allure-playwright']
                            ],

                            use: {
                                screenshot: 'only-on-failure',
                                video: 'retain-on-failure',
                                trace: 'retain-on-failure'
                            },

                            projects: [
                                { name: 'chromium', use: { browserName: 'chromium' }},
                                { name: 'firefox', use: { browserName: 'firefox' }},
                                { name: 'webkit', use: { browserName: 'webkit' }}
                            ]
                        });
                    """
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "npx playwright test"

                    if (params.SPEC_FILE?.trim()) {
                        cmd += " ${params.SPEC_FILE}"
                    }
                    if (params.TEST_TAG?.trim()) {
                        cmd += " --grep=\"${params.TEST_TAG}\""
                    }
                    if (params.BROWSER != 'all') {
                        cmd += " --project=${params.BROWSER}"
                    }

                    echo "‚ñ∂ Running: ${cmd}"
                    bat cmd
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat "npx allure generate allure-results --clean -o reports/allure-report"
            }
        }

        stage('Archive Reports & Artifacts') {
            steps {
                archiveArtifacts artifacts: """
                    reports/**,
                    allure-results/**,
                    **/*.png,
                    **/*.webm,
                    **/*.zip
                """, followSymlinks: false

                publishHTML(target: [
                    reportName: "Playwright HTML Report",
                    reportDir: "reports/html-report",
                    reportFiles: "index.html",
                    keepAll: true
                ])

                allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
            }
        }
    }

    post {
        always {
            script {
                // Safe JSON parsing
                def failedList = "JSON report not found"
                if (fileExists('reports/json-report/results.json')) {
                    def json = readJSON file: 'reports/json-report/results.json'

                    def failedTests = []
                    if (json.suites) {
                        failedTests = json.suites
                            .collectMany { it.specs }
                            .findAll { it.status == 'failed' }
                            .collect { it.title }
                    }

                    failedList = failedTests ? failedTests.join("<br>") : "All Tests Passed üéâ"
                }

                def recipient = params.EMAIL?.trim() ? params.EMAIL : "leelasonu12@gmail.com"

                emailext(
                    to: recipient,
                    subject: "Playwright Report - Build #${env.BUILD_NUMBER}",
                    body: """
                        <h2>Playwright Test Execution</h2>
                        <p><b>Status:</b> ${currentBuild.currentResult}</p>

                        <h3>üõë Failed Tests:</h3>
                        <p>${failedList}</p>

                        <h3>üìÑ Reports</h3>
                        <p><a href="${env.BUILD_URL}Playwright_HTML_Report">HTML Report</a></p>
                        <p><a href="${env.BUILD_URL}allure">Allure Report</a></p>
                        <p><a href="${env.BUILD_URL}artifact/reports/json-report/results.json">JSON Report</a></p>

                        <h3>üé• Videos / üì∏ Screenshots / üß≠ Traces</h3>
                        <p><a href="${env.BUILD_URL}artifact/">Browse Artifacts</a></p>
                        <hr>
                        <p>Triggered by Jenkins Pipeline</p>
                    """,
                    mimeType: 'text/html'
                )
            }
        }

        success {
            echo "üéâ Build Successful"
        }

        failure {
            echo "‚ùå Build Failed ‚Äî see attached reports"
        }
    }
}
