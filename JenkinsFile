pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
        skipDefaultCheckout()
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', defaultValue: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git', description: 'GitHub Repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to checkout')
        string(name: 'TAG', defaultValue: '', description: 'Test tag to run (e.g., @smoke, @regression). Leave empty if using SPEC.')
        string(name: 'SPEC', defaultValue: '', description: 'Specific .spec.ts file to run (e.g., tests/api/01_GETRequest.spec.ts). Leave empty if using TAG.')
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email recipients (comma-separated)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to run tests on')
    }

    environment {
        REPORTS_DIR = "test-reports"
        REPO_CHANGED = "false"
        TEST_STATUS = "UNKNOWN"
        TOTAL_TESTS = "0"
        PASSED_TESTS = "0"
        FAILED_TESTS = "0"
        TESTS_EXECUTED = "false"
        FAILED_TEST_NAMES = ""
    }

    stages {

        stage('Validate Parameters') {
            steps {
                script {
                    def tagProvided = params.TAG?.trim() != ""
                    def specProvided = params.SPEC?.trim() != ""
                    
                    if (tagProvided && specProvided) {
                        error("""
                        ‚ùå ERROR: Both TAG and SPEC parameters are provided!
                        
                        You must choose ONE of the following:
                        1. Provide only TAG (e.g., @smoke, @regression) to run tests with that tag
                        2. Provide only SPEC (e.g., tests/api/01_GETRequest.spec.ts) to run a specific file
                        
                        Please re-run the pipeline with only ONE parameter set.
                        """)
                    }
                    
                    if (!tagProvided && !specProvided) {
                        echo "‚ÑπÔ∏è  No TAG or SPEC provided - will run all tests"
                    }
                }
            }
        }

        stage('Git Change Detection & Checkout') {
            steps {
                script {
                    def lastRevisionFile = "${WORKSPACE}/.last-revision"
                    def hasLocalRepo = fileExists("${WORKSPACE}/.git")
                    def newChanges = false
                    
                    echo "üìÅ Checking for local repository..."
                    
                    if (hasLocalRepo) {
                        echo "‚úÖ Local repository found, checking for updates..."
                        
                        def retryCount = 0
                        def maxRetries = 2
                        def fetchSuccess = false
                        
                        while (retryCount < maxRetries && !fetchSuccess) {
                            try {
                                def branch = params.BRANCH ?: "main"
                                
                                // Get current commit hash before fetch
                                def currentCommit = bat(returnStdout: true, script: '''
                                    @echo off
                                    cd /d "%WORKSPACE%"
                                    git rev-parse HEAD
                                ''').trim()
                                
                                // Fetch latest changes
                                bat """
                                    @echo off
                                    cd /d "%WORKSPACE%"
                                    git fetch origin ${branch} --depth=1 --quiet
                                """
                                
                                // Get latest commit hash
                                def latestCommit = bat(returnStdout: true, script: """
                                    @echo off
                                    cd /d "%WORKSPACE%"
                                    git rev-parse origin/${branch}
                                """).trim()
                                
                                // Check if updates are available
                                if (!currentCommit.equals(latestCommit)) {
                                    echo "üîÑ New changes detected, pulling latest..."
                                    newChanges = true
                                    
                                    bat """
                                        @echo off
                                        cd /d "%WORKSPACE%"
                                        git pull origin ${branch} --depth=1 --quiet
                                    """
                                } else {
                                    echo "‚úÖ No new changes - using last cloned version"
                                    newChanges = false
                                }
                                
                                fetchSuccess = true
                                
                            } catch (Exception e) {
                                retryCount++
                                if (retryCount < maxRetries) {
                                    echo "‚ö†Ô∏è  Fetch attempt ${retryCount} failed, retrying..."
                                    sleep(10)
                                } else {
                                    error("Failed to fetch repository after ${maxRetries} attempts: ${e.message}")
                                }
                            }
                        }
                    } else {
                        echo "‚ùå Local repository not found, cloning..."
                        newChanges = true
                        
                        def cloneSuccess = false
                        def retryCount = 0
                        def maxRetries = 2
                        
                        while (retryCount < maxRetries && !cloneSuccess) {
                            try {
                                checkout([
                                    $class: 'GitSCM',
                                    branches: [[name: "*/${params.BRANCH}"]],
                                    userRemoteConfigs: [[url: params.GITHUB_REPO_URL]],
                                    extensions: [
                                        [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true, timeout: 30]
                                    ]
                                ])
                                
                                cloneSuccess = true
                                
                            } catch (Exception e) {
                                retryCount++
                                if (retryCount < maxRetries) {
                                    echo "‚ö†Ô∏è  Clone attempt ${retryCount} failed, retrying..."
                                    sleep(10)
                                    if (fileExists("${WORKSPACE}/.git")) {
                                        bat """
                                            @echo off
                                            cd /d "%WORKSPACE%"
                                            if exist .git rmdir /S /Q .git
                                        """
                                    }
                                } else {
                                    error("Failed to clone repository after ${maxRetries} attempts: ${e.message}")
                                }
                            }
                        }
                    }
                    
                    env.REPO_CHANGED = newChanges.toString()
                }
            }
        }

        stage('Install Dependencies') {
            when {
                expression { return env.REPO_CHANGED == "true" }
            }
            steps {
                script {
                    echo "üì¶ Installing dependencies..."
                    bat """
                        @echo off
                        set PATH=%APPDATA%\\npm;%PATH%
                        npm install --prefer-offline --no-audit
                        npx playwright install --with-deps
                    """
                }
            }
        }

        stage('Verify Playwright Installation') {
            steps {
                script {
                    echo "‚úÖ Verifying Playwright..."
                    bat """
                        @echo off
                        set PATH=%APPDATA%\\npm;%PATH%
                        npx playwright --version
                    """
                }
            }
        }

        stage('Clean Previous Reports') {
            steps {
                script {
                    echo "üßπ Cleaning old reports..."
                    bat """
                        @echo off
                        if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                        if exist playwright-report rmdir /S /Q playwright-report
                        if exist allure-results rmdir /S /Q allure-results
                        if exist allure-report rmdir /S /Q allure-report
                        if exist test-results rmdir /S /Q test-results
                        echo Cleaned old reports successfully
                    """
                }
            }
        }

        stage('Run Tests with Retry') {
            steps {
                script {
                    echo "üß™ Running Playwright tests..."
                    
                    def browserProjects = params.BROWSER == 'all' ? '' : "--project=${params.BROWSER}"
                    def testCmd = "npx playwright test ${browserProjects}".trim()
                    def maxRetries = 0
                    def currentRetry = 0
                    def testPassed = false

                    if (params.TAG?.trim()) {
                        testCmd += " --grep \"${params.TAG}\""
                        echo "üè∑Ô∏è  Running tests with tag: ${params.TAG}"
                    } else if (params.SPEC?.trim()) {
                        testCmd += " ${params.SPEC}"
                        echo "üìÑ Running specific test file: ${params.SPEC}"
                    } else {
                        echo "üéØ Running all tests"
                    }

                    while (currentRetry <= maxRetries && !testPassed) {
                        try {
                            if (currentRetry > 0) {
                                testCmd += " --last-failed"
                                echo "üîÑ Retry attempt ${currentRetry}: Running only failed tests"
                            }

                            def exitCode = bat(returnStatus: true, script: """
                                @echo off
                                set PATH=%APPDATA%\\npm;%PATH%
                                ${testCmd}
                                exit /b %ERRORLEVEL%
                            """)
                            
                            env.TESTS_EXECUTED = "true"
                            
                            if (exitCode == 0) {
                                testPassed = true
                                env.TEST_STATUS = "PASSED"
                            } else {
                                throw new Exception("Tests failed with exit code: ${exitCode}")
                            }

                        } catch (Exception e) {
                            currentRetry++
                            env.TEST_STATUS = "FAILED"
                            
                            if (currentRetry > maxRetries) {
                                echo "‚ö†Ô∏è  All test attempts completed"
                            } else {
                                echo "‚è≥ Waiting 5 seconds before retry..."
                                sleep(5)
                            }
                        }
                    }
                }
            }
        }

        stage('Extract Test Results') {
            when {
                expression { return env.TESTS_EXECUTED == "true" }
            }
            steps {
                script {
                    echo "üìä Extracting test results..."
                    
                    bat """
                        @echo off
                        setlocal enabledelayedexpansion
                        
                        set "total=0"
                        set "passed=0"
                        set "failed=0"
                        
                        if exist playwright-report\\index.html (
                            powershell -NoProfile -ExecutionPolicy Bypass -Command "& { try { [regex]::Matches((Get-Content 'playwright-report\\index.html' -Raw), '(\\d+)\\s+passed') | ForEach-Object { '!passed!' | Out-File -FilePath 'passed.txt' -Encoding ASCII -NoNewline }; } catch { } }"
                            
                            powershell -NoProfile -ExecutionPolicy Bypass -Command "& { try { [regex]::Matches((Get-Content 'playwright-report\\index.html' -Raw), '(\\d+)\\s+failed') | ForEach-Object { '!failed!' | Out-File -FilePath 'failed.txt' -Encoding ASCII -NoNewline }; } catch { } }"
                        )
                        
                        if exist passed.txt (
                            for /f "delims=" %%a in (passed.txt) do set "passed=%%a"
                        )
                        if exist failed.txt (
                            for /f "delims=" %%a in (failed.txt) do set "failed=%%a"
                        )
                        
                        if "!passed!"=="" set "passed=0"
                        if "!failed!"=="" set "failed=0"
                        
                        set /a total=!passed!+!failed!
                        if !total! equ 0 set /a total=1
                        
                        echo !total!,!passed!,!failed! > test_counts.txt
                    """
                    
                    if (fileExists('test_counts.txt')) {
                        def counts = readFile('test_counts.txt').trim().split(',')
                        env.TOTAL_TESTS = counts[0] ?: "0"
                        env.PASSED_TESTS = counts[1] ?: "0"
                        env.FAILED_TESTS = counts[2] ?: "0"
                    }
                    
                    def failedCount = env.FAILED_TESTS.toInteger()
                    if (failedCount > 0) {
                        env.TEST_STATUS = "FAILED"
                        currentBuild.result = 'FAILURE'
                    } else {
                        env.TEST_STATUS = "PASSED"
                        currentBuild.result = 'SUCCESS'
                    }
                    
                    echo "‚úÖ Tests: ${env.TOTAL_TESTS} total | ${env.PASSED_TESTS} passed | ${env.FAILED_TESTS} failed"
                }
            }
        }

        stage('Organize Reports') {
            when {
                expression { return env.TESTS_EXECUTED == "true" }
            }
            steps {
                script {
                    echo "üì¶ Organizing test reports..."
                    
                    bat """
                        @echo off
                        
                        if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}\\screenshots
                        mkdir ${REPORTS_DIR}\\videos
                        mkdir ${REPORTS_DIR}\\traces

                        REM Copy Playwright HTML report
                        if exist playwright-report\\index.html (
                            copy playwright-report\\index.html ${REPORTS_DIR}\\index.html /Y
                            if exist playwright-report\\data xcopy playwright-report\\data ${REPORTS_DIR}\\data\\ /E /I /Y /Q
                            if exist playwright-report\\trace xcopy playwright-report\\trace ${REPORTS_DIR}\\trace\\ /E /I /Y /Q
                        )

                        REM Copy artifacts from test-results
                        if exist test-results (
                            for /R test-results %%%%f in (*.png) do (
                                copy "%%%%f" "${REPORTS_DIR}\\screenshots\\" >nul 2>&1
                            )
                            
                            for /R test-results %%%%f in (*.webm) do (
                                copy "%%%%f" "${REPORTS_DIR}\\videos\\" >nul 2>&1
                            )
                            
                            for /R test-results %%%%f in (*.zip) do (
                                copy "%%%%f" "${REPORTS_DIR}\\traces\\" >nul 2>&1
                            )
                        )

                        REM Generate Allure report if allure-results exist
                        if exist allure-results (
                            set PATH=%APPDATA%\\npm;%PATH%
                            
                            where allure >nul 2>&1
                            if %%ERRORLEVEL%% NEQ 0 (
                                npm install -g allure-commandline --force
                            )
                            
                            mkdir ${REPORTS_DIR}\\allure-results
                            xcopy allure-results ${REPORTS_DIR}\\allure-results\\ /E /I /Y /Q
                            allure generate allure-results --clean -o ${REPORTS_DIR}\\allure-report
                            
                            REM Create allure.zip
                            cd ${REPORTS_DIR}
                            powershell -Command "Compress-Archive -Path allure-report -DestinationPath allure.zip -Force"
                            cd ..
                        )

                        echo Reports organized successfully
                    """
                    
                    echo "‚úÖ Reports directory structure created with index.html, traces, videos, and screenshots"
                }
            }
        }

        stage('Publish Reports') {
            when {
                expression { return fileExists("${REPORTS_DIR}/index.html") }
            }
            steps {
                script {
                    echo "üìÑ Publishing HTML reports..."
                    
                    if (fileExists("${REPORTS_DIR}/index.html")) {
                        publishHTML(target: [
                            reportDir: "${REPORTS_DIR}",
                            reportFiles: 'index.html',
                            reportName: 'Playwright HTML Report',
                            allowMissing: false,
                            keepAll: true,
                            alwaysLinkToLastBuild: true
                        ])
                    }
                    
                    if (fileExists("${REPORTS_DIR}/allure-report")) {
                        try {
                            publishHTML(target: [
                                reportDir: "${REPORTS_DIR}/allure-report",
                                reportFiles: 'index.html',
                                reportName: 'Allure Report',
                                allowMissing: false,
                                keepAll: true,
                                alwaysLinkToLastBuild: true
                            ])
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è  Could not publish Allure report: ${e.message}"
                        }
                    }
                }
            }
        }

    }

    post {
        always {
            script {
                // Archive reports
                if (fileExists("${REPORTS_DIR}")) {
                    archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true
                }

                def testStatus = env.TEST_STATUS ?: "UNKNOWN"
                def statusEmoji = (testStatus == "PASSED") ? "‚úÖ" : (testStatus == "FAILED") ? "‚ùå" : "‚ö†Ô∏è"
                def statusColor = (testStatus == "PASSED") ? "#4CAF50" : (testStatus == "FAILED") ? "#F44336" : "#FF9800"

                def totalTests = env.TOTAL_TESTS ?: "0"
                def passedTests = env.PASSED_TESTS ?: "0"
                def failedTests = env.FAILED_TESTS ?: "0"

                def buildUrl = env.BUILD_URL
                def reportLink = "${buildUrl}Playwright_20HTML_20Report/"
                def allureReportLink = "${buildUrl}allure/"
                def buildTime = new Date().format("yyyy-MM-dd HH:mm:ss z")

                // Build concise email with essential information
                def emailBody = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            background: ${statusColor};
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .content {
            padding: 25px;
        }
        .summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid ${statusColor};
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            font-weight: 500;
            color: #666;
        }
        .summary-value {
            font-weight: 700;
            color: #333;
        }
        .test-counts {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .count-box {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
        }
        .count-number {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .count-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-top: 4px;
        }
        .failed-tests {
            margin: 20px 0;
        }
        .failed-tests h3 {
            color: #F44336;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .failed-test-item {
            background: #ffebee;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #F44336;
            border-radius: 4px;
            font-size: 13px;
            color: #333;
        }
        .links {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .links h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .link-button {
            display: inline-block;
            padding: 10px 16px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .link-button:hover {
            background: #1976D2;
        }
        .footer {
            background: #263238;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-icon">${statusEmoji}</div>
            <h1>Test Report - ${testStatus}</h1>
        </div>

        <div class="content">
            <div class="summary">
                <div class="summary-row">
                    <span class="summary-label">Build #</span>
                    <span class="summary-value">${env.BUILD_NUMBER}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Status</span>
                    <span class="summary-value">${testStatus}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Browser</span>
                    <span class="summary-value">${params.BROWSER}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Time</span>
                    <span class="summary-value">${buildTime}</span>
                </div>
            </div>

            <div class="test-counts">
                <div class="count-box">
                    <div class="count-number">${totalTests}</div>
                    <div class="count-label">Total</div>
                </div>
                <div class="count-box">
                    <div class="count-number" style="color: #4CAF50;">${passedTests}</div>
                    <div class="count-label">Passed</div>
                </div>
                <div class="count-box">
                    <div class="count-number" style="color: #F44336;">${failedTests}</div>
                    <div class="count-label">Failed</div>
                </div>
            </div>

            <div class="links">
                <h3>üìä Reports & Artifacts</h3>
                <a href="${reportLink}" class="link-button">Playwright Report</a>
                <a href="${allureReportLink}" class="link-button">Allure Report</a>
                <a href="${buildUrl}artifact/${REPORTS_DIR}/" class="link-button">All Artifacts</a>
                <a href="${buildUrl}console" class="link-button">Console Log</a>
            </div>
        </div>

        <div class="footer">
            <p>Jenkins CI/CD Pipeline ‚Ä¢ ${env.JOB_NAME}</p>
        </div>
    </div>
</body>
</html>
                """

                emailext(
                    to: params.EMAIL,
                    subject: "${statusEmoji} Tests ${testStatus} - Build #${env.BUILD_NUMBER}",
                    mimeType: "text/html",
                    body: emailBody,
                    attachLog: false
                )
            }
        }
        
        success {
            script {
                echo "‚úÖ Pipeline completed successfully"
            }
        }
        
        failure {
            script {
                echo "‚ùå Pipeline failed"
            }
        }
    }
}