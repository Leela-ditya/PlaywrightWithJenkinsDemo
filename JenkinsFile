pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
        skipDefaultCheckout()
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', defaultValue: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git', description: 'GitHub Repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to checkout')
        string(name: 'TAG', defaultValue: '@StaticTable', description: 'Test tag to run (e.g., @smoke, @regression)')
        string(name: 'SPEC', defaultValue: '', description: 'Specific .spec.ts file to run (leave empty for all)')
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email recipients (comma-separated)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to run tests on')
    }

    environment {
        REPORTS_DIR = "test-reports"
        REPO_CHANGED = "false"
        TEST_STATUS = "UNKNOWN"
        SCREENSHOT_COUNT = "0"
        VIDEO_COUNT = "0"
        TRACE_COUNT = "0"
    }

    stages {

        stage('Git Change Detection & Checkout') {
            steps {
                script {
                    if (fileExists('.git')) {
                        echo "üìÇ Existing repository found. Validating..."
                        
                        try {
                            def remoteCheck = bat(returnStatus: true, script: 'git remote get-url origin 2>nul')
                            
                            if (remoteCheck != 0) {
                                echo "‚ö†Ô∏è Remote 'origin' not configured. Adding it..."
                                bat "git remote add origin ${params.GITHUB_REPO_URL}"
                            }
                            
                            def currentRemote = bat(returnStdout: true, script: 'git remote get-url origin 2>nul').trim()
                            if (currentRemote != params.GITHUB_REPO_URL) {
                                echo "üîÑ Remote URL changed. Updating..."
                                bat "git remote set-url origin ${params.GITHUB_REPO_URL}"
                            }
                            
                            echo "üîç Fetching latest changes from ${params.BRANCH}..."
                            bat "git fetch origin ${params.BRANCH}"
                            
                            def localCommit = bat(returnStdout: true, script: 'git rev-parse HEAD 2>nul').trim()
                            def remoteCommit = bat(returnStdout: true, script: "git rev-parse origin/${params.BRANCH} 2>nul").trim()
                            
                            echo "Local commit: ${localCommit}"
                            echo "Remote commit: ${remoteCommit}"
                            
                            if (localCommit != remoteCommit) {
                                echo "‚úÖ Changes detected! Pulling latest code..."
                                bat "git reset --hard origin/${params.BRANCH}"
                                env.REPO_CHANGED = "true"
                            } else {
                                echo "‚è≠Ô∏è No changes detected. Using existing code."
                                env.REPO_CHANGED = "false"
                            }
                            
                        } catch (Exception e) {
                            echo "‚ùå Git repository corrupted. Starting fresh..."
                            deleteDir()
                            git branch: params.BRANCH, url: params.GITHUB_REPO_URL
                            env.REPO_CHANGED = "true"
                        }
                        
                    } else {
                        echo "üÜï No existing repository. Cloning fresh..."
                        deleteDir()
                        git branch: params.BRANCH, url: params.GITHUB_REPO_URL
                        env.REPO_CHANGED = "true"
                    }
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    echo "üì¶ Installing dependencies..."
                    bat """
                        set PATH=%APPDATA%\\npm;%PATH%
                        npm install
                        npx playwright install --with-deps
                    """
                }
            }
        }

        stage('Verify Playwright Installation') {
            steps {
                script {
                    echo "üîç Verifying Playwright installation..."
                    bat """
                        set PATH=%APPDATA%\\npm;%PATH%
                        npx playwright --version
                    """
                }
            }
        }

        stage('Clean Previous Reports') {
            steps {
                script {
                    echo "üóëÔ∏è Cleaning all previous reports and artifacts..."
                    bat """
                        @echo off
                        if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                        if exist playwright-report rmdir /S /Q playwright-report
                        if exist allure-results rmdir /S /Q allure-results
                        if exist allure-report rmdir /S /Q allure-report
                        if exist test-results rmdir /S /Q test-results
                        if exist screenshot_count.txt del screenshot_count.txt
                        if exist video_count.txt del video_count.txt
                        if exist trace_count.txt del trace_count.txt
                        echo ‚úÖ All previous reports cleaned
                    """
                }
            }
        }

        stage('Run Tests with Retry') {
            steps {
                script {
                    def browserProjects = params.BROWSER == 'all' ? '' : "--project=${params.BROWSER}"
                    def testCmd = "npx playwright test ${browserProjects}"
                    def maxRetries = 1
                    def currentRetry = 0
                    def testPassed = false

                    if (params.TAG?.trim()) {
                        testCmd += " --grep ${params.TAG}"
                    }
                    if (params.SPEC?.trim()) {
                        testCmd += " ${params.SPEC}"
                    }

                    while (currentRetry <= maxRetries && !testPassed) {
                        try {
                            if (currentRetry > 0) {
                                echo "üîÑ RETRY ATTEMPT ${currentRetry} of ${maxRetries}"
                                testCmd += " --last-failed"
                            }

                            bat """
                                set PATH=%APPDATA%\\npm;%PATH%
                                ${testCmd}
                            """
                            testPassed = true
                            env.TEST_STATUS = "PASSED"
                            echo "‚úÖ Tests passed!"

                        } catch (Exception e) {
                            currentRetry++
                            env.TEST_STATUS = "FAILED"
                            
                            if (currentRetry > maxRetries) {
                                echo "‚ùå All retry attempts exhausted. Tests failed."
                                echo "‚ö†Ô∏è Continuing to generate reports..."
                            } else {
                                echo "‚ö†Ô∏è Test failed. Retrying in 5 seconds..."
                                sleep(5)
                            }
                        }
                    }
                }
            }
        }

        stage('Organize Reports') {
            steps {
                script {
                    catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                        bat """
                            @echo off
                            echo ==========================================
                            echo Organizing Test Reports
                            echo ==========================================
                            
                            REM Create clean test-reports directory
                            if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                            mkdir ${REPORTS_DIR}

                            REM Copy only index.html from playwright-report
                            if exist playwright-report\\index.html (
                                echo Copying Playwright index.html...
                                copy playwright-report\\index.html ${REPORTS_DIR}\\index.html /Y
                                
                                REM Copy required assets for the HTML to work
                                if exist playwright-report\\data (
                                    xcopy playwright-report\\data ${REPORTS_DIR}\\data\\ /E /I /Y /Q
                                )
                                if exist playwright-report\\trace (
                                    xcopy playwright-report\\trace ${REPORTS_DIR}\\trace\\ /E /I /Y /Q
                                )
                                echo ‚úÖ Playwright report copied
                            ) else (
                                echo ‚ö†Ô∏è Playwright HTML report not found
                            )

                            REM Create directories for artifacts
                            mkdir ${REPORTS_DIR}\\screenshots
                            mkdir ${REPORTS_DIR}\\videos
                            mkdir ${REPORTS_DIR}\\traces

                            REM Count artifacts FIRST (before copying)
                            set screenshot_count=0
                            set video_count=0
                            set trace_count=0

                            if exist test-results (
                                for /R test-results %%f in (*.png) do set /a screenshot_count+=1
                                for /R test-results %%f in (*.webm) do set /a video_count+=1
                                for /R test-results %%f in (*.zip) do set /a trace_count+=1
                            )

                            echo.
                            echo ==========================================
                            echo Artifact Counts (Before Copy):
                            echo Screenshots: %screenshot_count%
                            echo Videos: %video_count%
                            echo Traces: %trace_count%
                            echo ==========================================
                            echo.

                            REM Copy artifacts from test-results
                            if exist test-results (
                                echo Copying test artifacts...
                                
                                REM Copy screenshots
                                for /R test-results %%f in (*.png) do (
                                    copy "%%f" "${REPORTS_DIR}\\screenshots\\" >nul 2>&1
                                )
                                echo ‚úÖ Screenshots copied: %screenshot_count%
                                
                                REM Copy videos
                                for /R test-results %%f in (*.webm) do (
                                    copy "%%f" "${REPORTS_DIR}\\videos\\" >nul 2>&1
                                )
                                echo ‚úÖ Videos copied: %video_count%
                                
                                REM Copy traces
                                for /R test-results %%f in (*.zip) do (
                                    copy "%%f" "${REPORTS_DIR}\\traces\\" >nul 2>&1
                                )
                                echo ‚úÖ Traces copied: %trace_count%
                            ) else (
                                echo ‚ö†Ô∏è test-results directory not found
                            )

                            REM Generate and ZIP Allure report
                            if exist allure-results (
                                echo Generating Allure report...
                                set PATH=%APPDATA%\\npm;%PATH%
                                
                                where allure >nul 2>&1
                                if %ERRORLEVEL% EQU 0 (
                                    REM Generate temp allure report
                                    allure generate allure-results --clean -o allure-temp-report
                                    
                                    REM Create ZIP
                                    powershell -Command "Compress-Archive -Path 'allure-temp-report\\*' -DestinationPath '${REPORTS_DIR}\\allure-report.zip' -Force"
                                    
                                    REM Clean up temp
                                    rmdir /S /Q allure-temp-report
                                    
                                    echo ‚úÖ Allure ZIP created
                                ) else (
                                    echo ‚ö†Ô∏è Allure not installed. Installing...
                                    npm install -g allure-commandline --force
                                    
                                    allure generate allure-results --clean -o allure-temp-report
                                    powershell -Command "Compress-Archive -Path 'allure-temp-report\\*' -DestinationPath '${REPORTS_DIR}\\allure-report.zip' -Force"
                                    rmdir /S /Q allure-temp-report
                                    
                                    echo ‚úÖ Allure ZIP created
                                )
                                
                                REM Keep allure-results for Jenkins Allure Plugin
                                xcopy allure-results ${REPORTS_DIR}\\allure-results\\ /E /I /Y /Q
                                echo ‚úÖ Allure results copied for Jenkins plugin
                            ) else (
                                echo ‚ö†Ô∏è Allure results not found
                            )

                            REM Save counts to files for Groovy to read
                            echo.
                            echo ==========================================
                            echo Final Artifact Counts:
                            echo Screenshots: %screenshot_count%
                            echo Videos: %video_count%
                            echo Traces: %trace_count%
                            echo ==========================================
                            echo.
                            
                            echo %screenshot_count% > screenshot_count.txt
                            echo %video_count% > video_count.txt
                            echo %trace_count% > trace_count.txt

                            REM CRITICAL: Clean up ALL unwanted directories (but keep count files)
                            echo.
                            echo Cleaning up unwanted directories...
                            if exist playwright-report rmdir /S /Q playwright-report
                            if exist allure-results rmdir /S /Q allure-results
                            if exist test-results rmdir /S /Q test-results
                            if exist allure-report rmdir /S /Q allure-report
                            
                            echo ‚úÖ Cleanup completed (count files preserved)
                            echo.
                            echo Final test-reports structure:
                            dir ${REPORTS_DIR} /S
                        """
                        
                        // Store counts in environment variables from saved files
                        try {
                            if (fileExists('screenshot_count.txt')) {
                                env.SCREENSHOT_COUNT = readFile('screenshot_count.txt').trim()
                            } else {
                                env.SCREENSHOT_COUNT = "0"
                            }
                        } catch (Exception e) { 
                            env.SCREENSHOT_COUNT = "0" 
                        }

                        try {
                            if (fileExists('video_count.txt')) {
                                env.VIDEO_COUNT = readFile('video_count.txt').trim()
                            } else {
                                env.VIDEO_COUNT = "0"
                            }
                        } catch (Exception e) { 
                            env.VIDEO_COUNT = "0" 
                        }

                        try {
                            if (fileExists('trace_count.txt')) {
                                env.TRACE_COUNT = readFile('trace_count.txt').trim()
                            } else {
                                env.TRACE_COUNT = "0"
                            }
                        } catch (Exception e) { 
                            env.TRACE_COUNT = "0" 
                        }
                        
                        echo "üìä Counts saved - Screenshots: ${env.SCREENSHOT_COUNT}, Videos: ${env.VIDEO_COUNT}, Traces: ${env.TRACE_COUNT}"
                        
                        // Now clean up the count files
                        bat """
                            if exist screenshot_count.txt del screenshot_count.txt
                            if exist video_count.txt del video_count.txt
                            if exist trace_count.txt del trace_count.txt
                        """
                    }
                }
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                        // Publish Playwright HTML Report (index.html only)
                        if (fileExists("${REPORTS_DIR}/index.html")) {
                            publishHTML(target: [
                                reportDir: "${REPORTS_DIR}",
                                reportFiles: 'index.html',
                                reportName: 'Playwright HTML Report',
                                allowMissing: false,
                                keepAll: true,
                                alwaysLinkToLastBuild: true
                            ])
                            echo "‚úÖ Playwright HTML Report published"
                        } else {
                            echo "‚ö†Ô∏è Playwright report not found"
                        }
                        
                        // Publish Allure Report using Allure Plugin (for Jenkins UI)
                        if (fileExists("${REPORTS_DIR}/allure-results")) {
                            try {
                                allure([
                                    includeProperties: false,
                                    jdk: '',
                                    properties: [],
                                    reportBuildPolicy: 'ALWAYS',
                                    results: [[path: "${REPORTS_DIR}/allure-results"]]
                                ])
                                echo "‚úÖ Allure Report published via Allure Plugin"
                            } catch (Exception e) {
                                echo "‚ö†Ô∏è Allure Plugin not installed."
                                echo "Install from: Manage Jenkins > Plugins > Available > Search 'Allure'"
                                echo "üì¶ Allure ZIP is available for download in Build Artifacts"
                            }
                        } else {
                            echo "‚ö†Ô∏è Allure results not found"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                    // Archive test-reports with all contents
                    if (fileExists("${REPORTS_DIR}")) {
                        archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true
                        echo "‚úÖ Archived: test-reports folder with all contents"
                    }

                    def buildStatus = currentBuild.currentResult
                    def testStatus = env.TEST_STATUS ?: "UNKNOWN"
                    def statusEmoji = (testStatus == "PASSED") ? "‚úÖ" : "‚ùå"
                    def headerColor = (testStatus == "PASSED") ? "#4CAF50" : "#F44336"

                    def screenshotCount = env.SCREENSHOT_COUNT ?: "0"
                    def videoCount = env.VIDEO_COUNT ?: "0"
                    def traceCount = env.TRACE_COUNT ?: "0"

                    def buildUrl = env.BUILD_URL
                    def playwrightReportLink = "${buildUrl}Playwright_20HTML_20Report/"
                    def allureReportLink = "${buildUrl}Allure_20Report/"
                    def allureZipLink = "${buildUrl}artifact/${REPORTS_DIR}/allure-report.zip"
                    def screenshotsLink = "${buildUrl}artifact/${REPORTS_DIR}/screenshots/"
                    def videosLink = "${buildUrl}artifact/${REPORTS_DIR}/videos/"
                    def tracesLink = "${buildUrl}artifact/${REPORTS_DIR}/traces/"
                    def consoleLogLink = "${buildUrl}console"

                    def repoChangeStatus = (env.REPO_CHANGED == "true") ? 
                        "‚úÖ New changes detected and tested" : 
                        "‚è≠Ô∏è No changes - reused existing code"

                    def buildTime = new Date().format("EEE MMM dd HH:mm:ss z yyyy")

                    def emailBody = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playwright Test Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding: 0;
            margin: 0;
        }
        .email-container {
            max-width: 600px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header {
            background: ${headerColor};
            padding: 30px 20px;
            text-align: center;
            color: #ffffff;
        }
        .header-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 10px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .summary-section {
            padding: 20px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .buttons-section {
            padding: 20px;
            background: #f8f9fa;
        }
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .report-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 14px;
            background: #2196F3;
            color: #ffffff !important;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }
        .report-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        .button-icon {
            margin-right: 6px;
            font-size: 16px;
        }

        .footer {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        .footer-text {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }

        @media only screen and (max-width: 600px) {
            .summary-grid,
            .button-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <div class="header-icon">${statusEmoji}</div>
            <h1>Playwright Test Report</h1>
            <div class="status-badge">${testStatus}</div>
        </div>

        <div class="summary-section">
            <div class="section-title">üìä Test Summary</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Build Status</div>
                    <div class="summary-value">${buildStatus}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Test Status</div>
                    <div class="summary-value">${testStatus}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Build Number</div>
                    <div class="summary-value">#${env.BUILD_NUMBER}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Browser</div>
                    <div class="summary-value">${params.BROWSER}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Screenshots</div>
                    <div class="summary-value">${screenshotCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Videos</div>
                    <div class="summary-value">${videoCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Traces</div>
                    <div class="summary-value">${traceCount}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Repository</div>
                    <div class="summary-value" style="font-size: 12px;">${repoChangeStatus}</div>
                </div>
            </div>
        </div>

        <div class="buttons-section">
            <div class="section-title">üìÑ View Reports & Artifacts</div>
            <div class="button-grid">
                <a href="${playwrightReportLink}" class="report-button">
                    <span class="button-icon">üìä</span>
                    Playwright Report
                </a>
                <a href="${allureReportLink}" class="report-button">
                    <span class="button-icon">üìà</span>
                    Allure Report
                </a>
                <a href="${allureZipLink}" class="report-button">
                    <span class="button-icon">üì¶</span>
                    Download Allure ZIP
                </a>
                <a href="${screenshotsLink}" class="report-button">
                    <span class="button-icon">üì∏</span>
                    Screenshots (${screenshotCount})
                </a>
                <a href="${videosLink}" class="report-button">
                    <span class="button-icon">üé•</span>
                    Videos (${videoCount})
                </a>
                <a href="${tracesLink}" class="report-button">
                    <span class="button-icon">üîç</span>
                    Traces (${traceCount})
                </a>
                <a href="${consoleLogLink}" class="report-button">
                    <span class="button-icon">üñ•Ô∏è</span>
                    Console Log
                </a>
            </div>
        </div>

        <div class="footer">
            <div class="footer-text">ü§ñ Automated Jenkins CI/CD Pipeline</div>
            <div class="footer-text">üïê ${buildTime}</div>
            <div class="footer-text">üìß Build #${env.BUILD_NUMBER} - ${env.JOB_NAME}</div>
        </div>
    </div>
</body>
</html>
                    """

                    emailext(
                        to: params.EMAIL,
                        subject: "${statusEmoji} Playwright ${testStatus} - Build #${env.BUILD_NUMBER}",
                        mimeType: "text/html",
                        body: emailBody,
                        attachLog: false
                    )
                }
            }
        }
    }
}