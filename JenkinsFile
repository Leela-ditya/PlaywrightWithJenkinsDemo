pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
        skipDefaultCheckout()
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', defaultValue: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git', description: 'GitHub Repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to checkout')
        string(name: 'TAG', defaultValue: '@StaticTable', description: 'Test tag to run (e.g., @smoke, @regression)')
        string(name: 'SPEC', defaultValue: '', description: 'Specific .spec.ts file to run (leave empty for all)')
        string(name: 'EMAIL', defaultValue: 'leelasonu12@gmail.com', description: 'Email recipients (comma-separated)')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit', 'all'], description: 'Browser to run tests on')
    }

    environment {
        REPORTS_DIR = "test-reports"
        REPO_CHANGED = "false"
        TEST_FAILED_STEP = ""
    }

    stages {

        stage('Git Change Detection & Checkout') {
            steps {
                script {
                    def hasChanges = false
                    
                    if (fileExists('.git')) {
                        echo "üìÇ Existing repository found. Validating..."
                        
                        try {
                            def remoteCheck = bat(returnStatus: true, script: 'git remote get-url origin 2>nul')
                            
                            if (remoteCheck != 0) {
                                echo "‚ö†Ô∏è Remote 'origin' not configured. Adding it..."
                                bat "git remote add origin ${params.GITHUB_REPO_URL}"
                            }
                            
                            def currentRemote = bat(returnStdout: true, script: 'git remote get-url origin 2>nul').trim()
                            if (currentRemote != params.GITHUB_REPO_URL) {
                                echo "üîÑ Remote URL changed. Updating..."
                                bat "git remote set-url origin ${params.GITHUB_REPO_URL}"
                            }
                            
                            echo "üîç Fetching latest changes from ${params.BRANCH}..."
                            bat "git fetch origin ${params.BRANCH}"
                            
                            def localCommit = bat(returnStdout: true, script: 'git rev-parse HEAD 2>nul').trim()
                            def remoteCommit = bat(returnStdout: true, script: "git rev-parse origin/${params.BRANCH} 2>nul").trim()
                            
                            echo "Local commit: ${localCommit}"
                            echo "Remote commit: ${remoteCommit}"
                            
                            if (localCommit != remoteCommit) {
                                echo "‚úÖ Changes detected! Pulling latest code..."
                                
                                // Clean old reports before pulling new code
                                echo "üóëÔ∏è Cleaning old test reports..."
                                bat """
                                    if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                                    if exist playwright-report rmdir /S /Q playwright-report
                                    if exist allure-results rmdir /S /Q allure-results
                                    if exist allure-report rmdir /S /Q allure-report
                                    if exist test-results rmdir /S /Q test-results
                                """
                                
                                bat "git reset --hard origin/${params.BRANCH}"
                                hasChanges = true
                                env.REPO_CHANGED = "true"
                            } else {
                                echo "‚è≠Ô∏è No changes detected. Using existing code."
                                echo "‚ö†Ô∏è Previous test reports will be overwritten during test execution."
                                env.REPO_CHANGED = "false"
                            }
                            
                        } catch (Exception e) {
                            echo "‚ùå Git repository corrupted. Starting fresh..."
                            deleteDir()
                            git branch: params.BRANCH, url: params.GITHUB_REPO_URL
                            env.REPO_CHANGED = "true"
                        }
                        
                    } else {
                        echo "üÜï No existing repository. Cloning fresh..."
                        deleteDir()
                        git branch: params.BRANCH, url: params.GITHUB_REPO_URL
                        env.REPO_CHANGED = "true"
                    }
                }
            }
        }

        stage('Install Dependencies') {
            when {
                expression { env.REPO_CHANGED == "true" }
            }
            steps {
                script {
                    try {
                        echo "üì¶ Installing dependencies (repo changed)..."
                        bat """
                            set PATH=%APPDATA%\\npm;%PATH%
                            npm install
                            npx playwright install --with-deps
                        """
                    } catch (Exception e) {
                        env.TEST_FAILED_STEP = "Install Dependencies"
                        throw e
                    }
                }
            }
        }

        stage('Verify Playwright Installation') {
            steps {
                script {
                    echo "üîç Verifying Playwright installation..."
                    bat """
                        set PATH=%APPDATA%\\npm;%PATH%
                        npx playwright --version
                    """
                }
            }
        }

        stage('Clean Previous Reports') {
            steps {
                script {
                    echo "üóëÔ∏è Cleaning previous test reports and results..."
                    bat """
                        if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                        if exist playwright-report rmdir /S /Q playwright-report
                        if exist allure-results rmdir /S /Q allure-results
                        if exist allure-report rmdir /S /Q allure-report
                        if exist test-results rmdir /S /Q test-results
                        echo Previous reports cleaned successfully
                    """
                }
            }
        }

        stage('Run Tests with Retry') {
            steps {
                script {
                    def browserProjects = params.BROWSER == 'all' ? '' : "--project=${params.BROWSER}"
                    def testCmd = "npx playwright test ${browserProjects}"
                    def maxRetries = 3
                    def currentRetry = 0
                    def testPassed = false

                    if (params.TAG?.trim()) {
                        testCmd += " --grep ${params.TAG}"
                    }
                    if (params.SPEC?.trim()) {
                        testCmd += " ${params.SPEC}"
                    }

                    while (currentRetry < maxRetries && !testPassed) {
                        try {
                            if (currentRetry > 0) {
                                echo "üîÑ RETRY ATTEMPT ${currentRetry} of ${maxRetries - 1}"
                                testCmd += " --last-failed"
                            }

                            bat """
                                set PATH=%APPDATA%\\npm;%PATH%
                                ${testCmd}
                            """
                            testPassed = true
                            echo "‚úÖ Tests passed!"

                        } catch (Exception e) {
                            currentRetry++
                            env.TEST_FAILED_STEP = "Test Execution - Attempt ${currentRetry}"
                            
                            if (currentRetry >= maxRetries) {
                                echo "‚ùå All retry attempts exhausted. Tests failed."
                                throw e
                            } else {
                                echo "‚ö†Ô∏è Test failed. Retrying..."
                                sleep(5)
                            }
                        }
                    }
                }
            }
        }

        stage('Organize Reports') {
            steps {
                script {
                    bat """
                        @echo off
                        echo ==========================================
                        echo Organizing Test Reports and Artifacts
                        echo ==========================================
                        
                        REM Create main reports directory structure
                        if not exist ${REPORTS_DIR} mkdir ${REPORTS_DIR}
                        if not exist ${REPORTS_DIR}\\screenshots mkdir ${REPORTS_DIR}\\screenshots
                        if not exist ${REPORTS_DIR}\\videos mkdir ${REPORTS_DIR}\\videos
                        if not exist ${REPORTS_DIR}\\traces mkdir ${REPORTS_DIR}\\traces

                        REM Copy Playwright HTML Report to root of test-reports
                        if exist playwright-report\\index.html (
                            echo Copying Playwright HTML report to root...
                            copy playwright-report\\index.html ${REPORTS_DIR}\\index.html /Y
                            
                            REM Copy all Playwright assets
                            if exist playwright-report\\data (
                                xcopy playwright-report\\data ${REPORTS_DIR}\\data\\ /E /I /Y
                            )
                            if exist playwright-report\\trace (
                                xcopy playwright-report\\trace ${REPORTS_DIR}\\trace\\ /E /I /Y
                            )
                            echo Playwright report copied successfully
                        ) else (
                            echo WARNING: playwright-report/index.html not found
                        )

                        REM Organize test artifacts from test-results
                        if exist test-results (
                            echo Organizing test artifacts...
                            
                            REM Copy screenshots
                            echo Copying screenshots...
                            for /R test-results %%f in (*.png) do (
                                copy "%%f" "${REPORTS_DIR}\\screenshots\\" >nul 2>&1
                            )
                            
                            REM Copy videos
                            echo Copying videos...
                            for /R test-results %%f in (*.webm) do (
                                copy "%%f" "${REPORTS_DIR}\\videos\\" >nul 2>&1
                            )
                            
                            REM Copy traces
                            echo Copying traces...
                            for /R test-results %%f in (*.zip) do (
                                copy "%%f" "${REPORTS_DIR}\\traces\\" >nul 2>&1
                            )
                            
                            echo All artifacts organized successfully
                        ) else (
                            echo WARNING: test-results directory not found
                        )

                        REM Copy allure-results if exists
                        if exist allure-results (
                            echo Copying allure-results...
                            xcopy allure-results ${REPORTS_DIR}\\allure-results\\ /E /I /Y
                        ) else (
                            echo WARNING: allure-results directory not found
                        )

                        REM Copy allure-results if exists (keep original for Allure plugin)
                        if exist allure-results (
                            echo Copying allure-results...
                            xcopy allure-results ${REPORTS_DIR}\\allure-results\\ /E /I /Y
                            echo Allure results copied successfully
                        ) else (
                            echo WARNING: allure-results directory not found
                            echo Make sure your playwright.config.ts has allure-playwright reporter configured
                        )

                        REM Create summary file
                        echo ======================================== > ${REPORTS_DIR}\\report-summary.txt
                        echo Report Organization Complete >> ${REPORTS_DIR}\\report-summary.txt
                        echo ======================================== >> ${REPORTS_DIR}\\report-summary.txt
                        echo. >> ${REPORTS_DIR}\\report-summary.txt
                        echo Directory Structure: >> ${REPORTS_DIR}\\report-summary.txt
                        echo. >> ${REPORTS_DIR}\\report-summary.txt
                        tree ${REPORTS_DIR} /F >> ${REPORTS_DIR}\\report-summary.txt
                        
                        echo ==========================================
                        echo Report organization completed
                        echo ==========================================
                        
                        echo.
                        echo Final Report Structure:
                        tree ${REPORTS_DIR} /F
                    """
                }
            }
        }

        stage('Publish Reports') {
            steps {
                script {
                    // Publish Main Playwright HTML Report from test-reports root
                    if (fileExists("${REPORTS_DIR}/index.html")) {
                        publishHTML(target: [
                            reportDir: "${REPORTS_DIR}",
                            reportFiles: 'index.html',
                            reportName: 'Playwright HTML Report',
                            allowMissing: false,
                            keepAll: true,
                            alwaysLinkToLastBuild: true
                        ])
                        echo "‚úÖ Playwright HTML Report published successfully"
                    }
                    
                    // Publish Allure Report using Allure Plugin
                    if (fileExists("${REPORTS_DIR}/allure-results")) {
                        try {
                            allure([
                                includeProperties: false,
                                jdk: '',
                                properties: [],
                                reportBuildPolicy: 'ALWAYS',
                                results: [[path: "${REPORTS_DIR}/allure-results"]]
                            ])
                            echo "‚úÖ Allure Report published successfully"
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Allure Plugin not found. Installing Allure Jenkins Plugin is required."
                            echo "‚ö†Ô∏è Go to: Manage Jenkins > Plugins > Available Plugins > Search 'Allure' > Install"
                            
                            // Fallback: Try HTML Publisher with proper CSP settings
                            if (fileExists("${REPORTS_DIR}/allure-report/index.html")) {
                                publishHTML(target: [
                                    reportDir: "${REPORTS_DIR}/allure-report",
                                    reportFiles: 'index.html',
                                    reportName: 'Allure HTML Report',
                                    allowMissing: true,
                                    keepAll: true,
                                    alwaysLinkToLastBuild: true,
                                    reportTitles: 'Allure Report'
                                ])
                                echo "‚ö†Ô∏è Published Allure as HTML (limited functionality). Install Allure Plugin for full features."
                            }
                        }
                    } else {
                        echo "‚ö†Ô∏è Allure results not found at ${REPORTS_DIR}/allure-results"
                    }
                }
            }
        }

        stage('Test Allure') {
            steps {
                script {
                    // Check if Allure plugin is available
                    try {
                        allure([
                            includeProperties: false,
                            results: [[path: 'test-reports/allure-results']]
                        ])
                        echo "‚úÖ Allure plugin is installed and working!"
                    } catch (Exception e) {
                        echo "‚ùå Allure plugin not found: ${e.message}"
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true

            script {
                def buildStatus = currentBuild.currentResult
                def buildStatusText = buildStatus
                def testStatus = (buildStatus == "SUCCESS") ? "PASSED" : "FAILED"
                def statusColor = (buildStatus == "SUCCESS") ? "#4CAF50" : "#F44336"
                def statusEmoji = (buildStatus == "SUCCESS") ? "üéâ" : "‚ùå"
                def headerColor = (buildStatus == "SUCCESS") ? "#4CAF50" : "#F44336"

                // Count artifacts
                def screenshotCount = "0"
                def videoCount = "0"
                def traceCount = "0"

                try {
                    screenshotCount = powershell(returnStdout: true, script: """
                        if (Test-Path '${REPORTS_DIR}\\screenshots') {
                            (Get-ChildItem '${REPORTS_DIR}\\screenshots' -File -ErrorAction SilentlyContinue).Count
                        } else { 0 }
                    """).trim()
                } catch (Exception e) { screenshotCount = "0" }

                try {
                    videoCount = powershell(returnStdout: true, script: """
                        if (Test-Path '${REPORTS_DIR}\\videos') {
                            (Get-ChildItem '${REPORTS_DIR}\\videos' -File -ErrorAction SilentlyContinue).Count
                        } else { 0 }
                    """).trim()
                } catch (Exception e) { videoCount = "0" }

                try {
                    traceCount = powershell(returnStdout: true, script: """
                        if (Test-Path '${REPORTS_DIR}\\traces') {
                            (Get-ChildItem '${REPORTS_DIR}\\traces' -File -ErrorAction SilentlyContinue).Count
                        } else { 0 }
                    """).trim()
                } catch (Exception e) { traceCount = "0" }

                // Build URLs
                def buildUrl = env.BUILD_URL
                def playwrightReportLink = "${buildUrl}Playwright_20HTML_20Report/"
                def allureReportLink = "${buildUrl}Allure_20Report/"
                def screenshotsLink = "${buildUrl}artifact/${REPORTS_DIR}/screenshots/"
                def videosLink = "${buildUrl}artifact/${REPORTS_DIR}/videos/"
                def tracesLink = "${buildUrl}artifact/${REPORTS_DIR}/traces/"
                def artifactsLink = "${buildUrl}artifact/${REPORTS_DIR}/"
                def consoleLogLink = "${buildUrl}console"

                def repoChangeStatus = (env.REPO_CHANGED == "true") ? 
                    "‚úÖ New changes detected and pulled" : 
                    "‚è≠Ô∏è No changes - used existing code"

                // Build time
                def buildTime = new Date().format("EEE MMM dd HH:mm:ss z yyyy")

                // Mobile-optimized email template
                def emailBody = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playwright Test Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 0;
            margin: 0;
        }
        .email-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #1a1a1a;
        }
        
        .header {
            background: ${headerColor};
            padding: 30px 20px;
            text-align: center;
            border-radius: 0;
        }
        .header-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 10px 0;
            color: #ffffff;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            color: #ffffff;
        }

        .summary-section {
            background: #2a2a2a;
            margin: 0;
            padding: 0;
        }
        .section-title {
            background: #333333;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 1px solid #444;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        .summary-table thead {
            background: #4CAF50;
        }
        .summary-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #ffffff;
        }
        .summary-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            color: #e0e0e0;
        }
        .summary-table tr:last-child td {
            border-bottom: none;
        }
        .property-name {
            color: #bbb;
            font-weight: 500;
        }

        .reports-section {
            background: #2a2a2a;
            padding: 20px;
        }
        .reports-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ffffff;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .report-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 16px;
            background: #2196F3;
            color: #ffffff !important;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.3s;
        }
        .report-button:hover {
            background: #1976D2;
        }
        .report-button.secondary {
            background: #5c6bc0;
        }
        .report-button.secondary:hover {
            background: #3f51b5;
        }
        .button-icon {
            margin-right: 6px;
            font-size: 16px;
        }

        .generated-reports {
            margin-top: 20px;
        }
        .reports-list-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #ffffff;
        }
        .report-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }
        .report-item:last-child {
            border-bottom: none;
        }
        .report-item-icon {
            margin-right: 8px;
            font-size: 16px;
            flex-shrink: 0;
        }
        .report-item-text {
            color: #e0e0e0;
            line-height: 1.5;
        }
        .report-item-title {
            font-weight: 600;
            color: #ffffff;
        }

        .links-section {
            background: #2a2a2a;
            padding: 20px;
            margin-top: 2px;
        }
        .link-item {
            margin-bottom: 12px;
            font-size: 13px;
        }
        .link-label {
            color: #bbb;
            font-weight: 600;
        }
        .link-url {
            color: #2196F3;
            word-break: break-all;
            text-decoration: none;
        }

        .footer {
            background: #1a1a1a;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #333;
        }
        .footer-item {
            font-size: 12px;
            color: #888;
            margin: 5px 0;
        }

        @media only screen and (max-width: 600px) {
            .header {
                padding: 20px 15px;
            }
            .header h1 {
                font-size: 18px;
            }
            .header-icon {
                font-size: 36px;
            }
            .button-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .summary-table th,
            .summary-table td {
                padding: 10px 15px;
                font-size: 13px;
            }
            .reports-section,
            .links-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <div class="header-icon">${statusEmoji}</div>
            <h1>Playwright Test Execution Report</h1>
            <div class="status-badge">Status: ${testStatus}</div>
        </div>

        <div class="summary-section">
            <div class="section-title">üìä Test Summary</div>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="property-name">Build Status</td>
                        <td>${buildStatusText}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Test Status</td>
                        <td>${testStatus}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Repository Status</td>
                        <td>${repoChangeStatus}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Build Number</td>
                        <td>#${env.BUILD_NUMBER}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Job Name</td>
                        <td>${env.JOB_NAME}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Browser</td>
                        <td>${params.BROWSER}</td>
                    </tr>
                    <tr>
                        <td class="property-name">TAG</td>
                        <td>${params.TAG ?: 'Not specified'}</td>
                    </tr>
                    <tr>
                        <td class="property-name">SPEC File</td>
                        <td>${params.SPEC ?: 'All tests'}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Screenshots</td>
                        <td>${screenshotCount}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Videos</td>
                        <td>${videoCount}</td>
                    </tr>
                    <tr>
                        <td class="property-name">Traces</td>
                        <td>${traceCount}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="reports-section">
            <div class="reports-title">üìÑ View Reports (Click Links Below)</div>
            
            <div class="button-grid">
                <a href="${playwrightReportLink}" class="report-button">
                    <span class="button-icon">üìä</span>
                    Playwright Report
                </a>
                <a href="${allureReportLink}" class="report-button">
                    <span class="button-icon">üìà</span>
                    Allure Report
                </a>
                <a href="${artifactsLink}" class="report-button secondary">
                    <span class="button-icon">üìÅ</span>
                    All Artifacts
                </a>
                <a href="${consoleLogLink}" class="report-button secondary">
                    <span class="button-icon">üñ•Ô∏è</span>
                    Console Log
                </a>
            </div>

            <div class="generated-reports">
                <div class="reports-list-title">üé® Generated Reports</div>
                
                <div class="report-item">
                    <span class="report-item-icon">‚úÖ</span>
                    <div class="report-item-text">
                        <span class="report-item-title">Playwright HTML Report</span> - Interactive test results with filters
                    </div>
                </div>
                
                <div class="report-item">
                    <span class="report-item-icon">‚úÖ</span>
                    <div class="report-item-text">
                        <span class="report-item-title">Allure Report</span> - Enhanced visualization with graphs
                    </div>
                </div>
                
                <div class="report-item">
                    <span class="report-item-icon">üì∏</span>
                    <div class="report-item-text">
                        <span class="report-item-title">Screenshots</span> - ${screenshotCount} screenshot(s) captured
                    </div>
                </div>
                
                <div class="report-item">
                    <span class="report-item-icon">üé•</span>
                    <div class="report-item-text">
                        <span class="report-item-title">Videos</span> - ${videoCount} video recording(s)
                    </div>
                </div>
                
                <div class="report-item">
                    <span class="report-item-icon">üîç</span>
                    <div class="report-item-text">
                        <span class="report-item-title">Trace Viewer</span> - ${traceCount} trace file(s) for debugging
                    </div>
                </div>
            </div>
        </div>

        <div class="links-section">
            <div class="reports-title">üîó Direct Links</div>
            
            <div class="link-item">
                <div class="link-label">üìä Playwright HTML Report:</div>
                <a href="${playwrightReportLink}" class="link-url">${playwrightReportLink}</a>
            </div>
            
            <div class="link-item">
                <div class="link-label">üìà Allure Report:</div>
                <a href="${allureReportLink}" class="link-url">${allureReportLink}</a>
            </div>
            
            <div class="link-item">
                <div class="link-label">üìÅ Download Artifacts:</div>
                <a href="${artifactsLink}" class="link-url">${artifactsLink}</a>
            </div>
            
            <div class="link-item">
                <div class="link-label">üì∏ Screenshots:</div>
                <a href="${screenshotsLink}" class="link-url">${screenshotsLink}</a>
            </div>
            
            <div class="link-item">
                <div class="link-label">üé• Videos:</div>
                <a href="${videosLink}" class="link-url">${videosLink}</a>
            </div>
            
            <div class="link-item">
                <div class="link-label">üîç Traces:</div>
                <a href="${tracesLink}" class="link-url">${tracesLink}</a>
            </div>
        </div>

        <div class="footer">
            <div class="footer-item">
                üìß Automated Jenkins CI/CD Pipeline
            </div>
            <div class="footer-item">
                üïê Build Time: ${buildTime}
            </div>
            <div class="footer-item">
                üè† Jenkins: <a href="${env.JENKINS_URL}" style="color: #2196F3;">${env.JENKINS_URL}</a>
            </div>
        </div>
    </div>
</body>
</html>
                """

                emailext(
                    to: params.EMAIL,
                    subject: "${statusEmoji} Playwright ${testStatus} - Build #${env.BUILD_NUMBER} - ${env.JOB_NAME}",
                    mimeType: "text/html",
                    body: emailBody,
                    attachLog: false
                )
            }
        }
    }
}