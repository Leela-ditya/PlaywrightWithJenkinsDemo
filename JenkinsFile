pipeline {
    agent any

    options {
        timestamps()
        durabilityHint('MAX_SURVIVABILITY')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    parameters {
        string(name: 'GITHUB_REPO_URL', defaultValue: ' ', description: 'Enter the GitHub Repository URL')
        string(name: 'BRANCH', defaultValue: 'main', description: 'Branch to checkout')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Browser to run tests')
        string(name: 'TAG', defaultValue: '', description: 'Tag to run specific tests')
        string(name: 'SPEC', defaultValue: '', description: 'Run specific .spec.ts file')
        string(name: 'EMAIL', defaultValue: ' ', description: 'Email recipients (comma separated)')
    }

    environment {
        REPORTS_DIR = "test-reports"
        HTML_REPORT_DIR = "test-reports/html"
    }

    stages {

        stage('Checkout') {
            steps {
                deleteDir()
                git branch: params.BRANCH, url: params.GITHUB_REPO_URL
            }
        }

        stage('Install Dependencies') {
            steps {
                bat """
                    set PATH=%APPDATA%\\npm;%PATH%
                    npm install
                    npx playwright install --with-deps
                    npm install -g allure-commandline --force
                """
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def cmd = "npx playwright test --browser=${params.BROWSER}"

                    if (params.TAG?.trim()) {
                        cmd += " --grep @${params.TAG}"
                    }
                    if (params.SPEC?.trim()) {
                        cmd += " ${params.SPEC}"
                    }

                    bat """
                        set PATH=%APPDATA%\\npm;%PATH%
                        ${cmd}
                    """
                }
            }
        }

        stage('Organize Reports') {
            steps {
                script {
                    bat """
                        if exist ${REPORTS_DIR} rmdir /S /Q ${REPORTS_DIR}
                        mkdir ${REPORTS_DIR}
                        mkdir ${HTML_REPORT_DIR}

                        if exist playwright-report xcopy playwright-report ${HTML_REPORT_DIR} /E /I /Y

                        if exist test-results xcopy test-results ${REPORTS_DIR}\\test-results /E /I /Y

                        if exist allure-results (
                            "%APPDATA%\\npm\\allure" generate allure-results --clean -o allure-report
                            powershell -Command "Compress-Archive -Path 'allure-report/*' -DestinationPath '${REPORTS_DIR}/allure-report.zip' -Force"
                        )

                        if exist test-results (
                            powershell -Command "Compress-Archive -Path 'test-results/*' -DestinationPath '${REPORTS_DIR}/test-results.zip' -Force"
                        )
                    """
                }
            }
        }

        stage('Publish Reports') {
            steps {
                publishHTML(target: [
                    reportDir: "${HTML_REPORT_DIR}",
                    reportFiles: 'index.html',
                    reportName: 'Playwright HTML Report',
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])
            }
        }
    }

    post {

        always {
            archiveArtifacts artifacts: "${REPORTS_DIR}/**", allowEmptyArchive: true

            script {
                def buildStatus = currentBuild.currentResult
                def testStatus = (buildStatus == "SUCCESS") ? "Passed" : "Failed"

                def screenshotCount = sh(returnStdout: true, script: 'dir /b test-results\\**\\*.png 2>nul | find /c /v ""').trim()
                def videoCount = sh(returnStdout: true, script: 'dir /b test-results\\**\\*.webm 2>nul | find /c /v ""').trim()
                def traceCount = sh(returnStdout: true, script: 'dir /b test-results\\**\\*.zip 2>nul | find /c /v ""').trim()

                def buildUrl = env.BUILD_URL
                def htmlReportLink = "${buildUrl}Playwright_20HTML_20Report/"
                def allureZipLink = "${buildUrl}artifact/${REPORTS_DIR}/allure-report.zip"
                def artifactsLink = "${buildUrl}artifact/${REPORTS_DIR}/"
                def consoleLogLink = "${buildUrl}console"

                emailext(
                    to: params.EMAIL,
                    subject: "Playwright Test Report - ${testStatus} (Build #${env.BUILD_NUMBER})",
                    mimeType: "text/html",
                    body: """
                        <html>
                        <head>
                            <style>
                                body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; padding: 20px; text-align: center; }
                                .header { background-color: #2d2d2d; color: #fff; padding: 20px; border-radius: 8px; }
                                .content { background-color: #ffffff; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0px 0px 10px #ddd; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { padding: 10px; border: 1px solid #ddd; }
                                th { background-color: #333; color: #fff; }
                                .footer { margin-top: 20px; font-size: 12px; color: #555; }
                                .report-link { display: block; margin: 10px 0; font-size: 16px; color: #1a73e8; text-decoration: none; }
                            </style>
                        </head>

                        <body>
                            <div class="header">
                                <h1>üé≠ Playwright Test Execution Report</h1>
                                <h2>Status: ${testStatus}</h2>
                            </div>
                            <div class="content">
                                <h3>üìä Test Summary</h3>
                                <table>
                                    <tr><th>Property</th><th>Value</th></tr>
                                    <tr><td>Build Status</td><td>${buildStatus}</td></tr>
                                    <tr><td>Test Status</td><td>${testStatus}</td></tr>
                                    <tr><td>Repository</td><td>${params.GITHUB_REPO_URL}</td></tr>
                                    <tr><td>Branch</td><td>${params.BRANCH}</td></tr>
                                    <tr><td>Browser</td><td>${params.BROWSER}</td></tr>
                                    <tr><td>TAG</td><td>${params.TAG ?: "None"}</td></tr>
                                    <tr><td>SPEC File</td><td>${params.SPEC ?: "None"}</td></tr>
                                    <tr><td>Screenshots</td><td>${screenshotCount}</td></tr>
                                    <tr><td>Videos</td><td>${videoCount}</td></tr>
                                    <tr><td>Traces</td><td>${traceCount}</td></tr>
                                </table>

                                <h3>üìÑ View Reports</h3>
                                <p>
                                    <a class="report-link" href="${htmlReportLink}">üìä HTML Report</a>
                                    <a class="report-link" href="${allureZipLink}">üì¶ Allure ZIP</a>
                                    <a class="report-link" href="${artifactsLink}">üìÅ All Artifacts</a>
                                    <a class="report-link" href="${consoleLogLink}">üñ•Ô∏è Console Log</a>
                                </p>
                            </div>

                            <div class="footer">
                                <p>
                                    üìß This is an automated email from Jenkins CI/CD Pipeline<br>
                                    ‚è∞ Build Time: ${new Date()}<br>
                                    üè† Jenkins: ${env.JENKINS_URL}
                                </p>
                            </div>
                        </body>
                        </html>
                    """
                )
            }
        }
    }
}
