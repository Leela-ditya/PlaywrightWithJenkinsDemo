pipeline {
    agent any

    options {
        timestamps()
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }

    parameters {
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'Choose browser')
        string(name: 'TEST_TAG', defaultValue: '', description: 'Enter tag (e.g., @smoke). Leave empty if using SPEC.')
        string(name: 'SPEC_FILE', defaultValue: '', description: 'Enter spec file (e.g., tests/login.spec.ts). Leave empty if using TAG.')
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Leela-ditya/PlaywrightWithJenkinsDemo.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat '''
                    npm ci
                    npx playwright install
                '''
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    def tag = params.TEST_TAG?.trim()
                    def spec = params.SPEC_FILE?.trim()
                    def command = "npx playwright test"

                    if (spec) {
                        command += " ${spec}"
                    } else if (tag) {
                        command += " --grep ${tag}"
                    }

                    command += " --project=${params.BROWSER}"
                    command += " --reporter=html,json,junit,allure-playwright"

                    bat "${command} --output=test-results"
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                bat '''
                    where allure >nul 2>nul
                    if %ERRORLEVEL% NEQ 0 (
                        echo Allure not found. Installing Allure CLI...
                        npm install -g allure-commandline --force
                    ) else (
                        echo Allure CLI already installed.
                    )

                    if exist allure-results (
                        npx allure generate allure-results --clean -o allure-report
                    ) else (
                        echo No allure-results directory found. Skipping report generation.
                    )
                '''
            }
        }

        stage('Publish Reports') {
            steps {
                publishHTML([
                    reportDir: 'playwright-report',
                    reportFiles: 'index.html',
                    reportName: 'Playwright HTML Report',
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])

                allure([
                    results: [[path: 'allure-results']],
                    reportBuildPolicy: 'ALWAYS'
                ])

                junit allowEmptyResults: true, testResults: 'test-results/**/*.xml'

                archiveArtifacts artifacts: 'playwright-report/**, allure-report/**, test-results/**', allowEmptyArchive: true
            }
        }
    }

    post {
        success {
            echo "✅ Tests passed successfully!"
        }
        failure {
            echo "❌ Tests failed. Check reports for details."
        }
    }
}