pipeline {
  agent any

  environment {
    REPORT_DIR = 'playwright-report'
  }

  parameters {
    string(name: 'SPEC_FILE', defaultValue: '', description: 'Run only this spec file/folder (example: tests/login.spec.ts). Leave empty to run by TEST_TAG or all tests.')
    string(name: 'TEST_TAG',  defaultValue: '', description: 'Playwright grep/tag (example: @smoke). Used if SPEC_FILE is empty.')
    booleanParam(name: 'USE_WINDOWS', defaultValue: false, description: 'Run on Windows agent.')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install dependencies') {
      steps {
        script {
          if (params.USE_WINDOWS) {
            bat 'npm ci'
          } else {
            sh 'npm ci'
          }
        }
      }
    }

    stage('Install Playwright Browsers') {
      steps {
        script {
          if (params.USE_WINDOWS) {
            bat 'npx playwright install'
          } else {
            sh 'npx playwright install --with-deps || npx playwright install'
          }
        }
      }
    }

    stage('Run Tests') {
      steps {
        script {
          def cmd = "npx playwright test --reporter=html --output=${env.WORKSPACE}/${REPORT_DIR}"

          if (params.SPEC_FILE?.trim()) {
            cmd = "npx playwright test ${params.SPEC_FILE} --reporter=html --output=${env.WORKSPACE}/${REPORT_DIR}"
          } else if (params.TEST_TAG?.trim()) {
            cmd = "npx playwright test --grep=\"${params.TEST_TAG}\" --reporter=html --output=${env.WORKSPACE}/${REPORT_DIR}"
          }

          if (params.USE_WINDOWS) {
            bat cmd
          } else {
            sh cmd
          }
        }
      }
    }

    stage('Archive & Publish HTML Report') {
      steps {
        script {
          archiveArtifacts artifacts: "${REPORT_DIR}/**", allowEmptyArchive: true

          publishHTML(target: [
            reportDir: REPORT_DIR,
            reportFiles: 'index.html',
            reportName: 'Playwright Report',
            keepAll: true,
            alwaysLinkToLastBuild: true
          ])
        }
      }
    }
  }

  post {
    always {
      echo "Build complete."
    }
    success {
      echo "Build Success!"
    }
    failure {
      echo "Build Failed!"
    }
  }
}
